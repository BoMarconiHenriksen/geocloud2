(function(window,document,undefined){L.MarkerClusterGroup=L.FeatureGroup.extend({options:{maxClusterRadius:80,iconCreateFunction:null,spiderfyOnMaxZoom:true,showCoverageOnHover:true,zoomToBoundsOnClick:true,singleMarkerMode:false,disableClusteringAtZoom:null,removeOutsideVisibleBounds:true,animateAddingMarkers:false,spiderfyDistanceMultiplier:1,polygonOptions:{}},initialize:function(options){L.Util.setOptions(this,options);if(!this.options.iconCreateFunction){this.options.iconCreateFunction=this._defaultIconCreateFunction}this._featureGroup=L.featureGroup();this._featureGroup.on(L.FeatureGroup.EVENTS,this._propagateEvent,this);this._nonPointGroup=L.featureGroup();this._nonPointGroup.on(L.FeatureGroup.EVENTS,this._propagateEvent,this);this._inZoomAnimation=0;this._needsClustering=[];this._needsRemoving=[];this._currentShownBounds=null},addLayer:function(layer){if(layer instanceof L.LayerGroup){var array=[];for(var i in layer._layers){array.push(layer._layers[i])}return this.addLayers(array)}if(!layer.getLatLng){this._nonPointGroup.addLayer(layer);return this}if(!this._map){this._needsClustering.push(layer);return this}if(this.hasLayer(layer)){return this}if(this._unspiderfy){this._unspiderfy()}this._addLayer(layer,this._maxZoom);var visibleLayer=layer,currentZoom=this._map.getZoom();if(layer.__parent){while(visibleLayer.__parent._zoom>=currentZoom){visibleLayer=visibleLayer.__parent}}if(this._currentShownBounds.contains(visibleLayer.getLatLng())){if(this.options.animateAddingMarkers){this._animationAddLayer(layer,visibleLayer)}else{this._animationAddLayerNonAnimated(layer,visibleLayer)}}return this},removeLayer:function(layer){if(layer instanceof L.LayerGroup){var array=[];for(var i in layer._layers){array.push(layer._layers[i])}return this.removeLayers(array)}if(!layer.getLatLng){this._nonPointGroup.removeLayer(layer);return this}if(!this._map){if(!this._arraySplice(this._needsClustering,layer)&&this.hasLayer(layer)){this._needsRemoving.push(layer)}return this}if(!layer.__parent){return this}if(this._unspiderfy){this._unspiderfy();this._unspiderfyLayer(layer)}this._removeLayer(layer,true);if(this._featureGroup.hasLayer(layer)){this._featureGroup.removeLayer(layer);if(layer.setOpacity){layer.setOpacity(1)}}return this},addLayers:function(layersArray){var i,l,m,onMap=this._map,fg=this._featureGroup,npg=this._nonPointGroup;for(i=0,l=layersArray.length;i<l;i++){m=layersArray[i];if(!m.getLatLng){npg.addLayer(m);continue}if(this.hasLayer(m)){continue}if(!onMap){this._needsClustering.push(m);continue}this._addLayer(m,this._maxZoom);if(m.__parent){if(m.__parent.getChildCount()===2){var markers=m.__parent.getAllChildMarkers(),otherMarker=markers[0]===m?markers[1]:markers[0];fg.removeLayer(otherMarker)}}}if(onMap){fg.eachLayer(function(c){if(c instanceof L.MarkerCluster&&c._iconNeedsUpdate){c._updateIcon()}});this._topClusterLevel._recursivelyAddChildrenToMap(null,this._zoom,this._currentShownBounds)}return this},removeLayers:function(layersArray){var i,l,m,fg=this._featureGroup,npg=this._nonPointGroup;if(!this._map){for(i=0,l=layersArray.length;i<l;i++){m=layersArray[i];this._arraySplice(this._needsClustering,m);npg.removeLayer(m)}return this}for(i=0,l=layersArray.length;i<l;i++){m=layersArray[i];if(!m.__parent){npg.removeLayer(m);continue}this._removeLayer(m,true,true);if(fg.hasLayer(m)){fg.removeLayer(m);if(m.setOpacity){m.setOpacity(1)}}}this._topClusterLevel._recursivelyAddChildrenToMap(null,this._zoom,this._currentShownBounds);fg.eachLayer(function(c){if(c instanceof L.MarkerCluster){c._updateIcon()}});return this},clearLayers:function(){if(!this._map){this._needsClustering=[];delete this._gridClusters;delete this._gridUnclustered}if(this._noanimationUnspiderfy){this._noanimationUnspiderfy()}this._featureGroup.clearLayers();this._nonPointGroup.clearLayers();this.eachLayer(function(marker){delete marker.__parent});if(this._map){this._generateInitialClusters()}return this},getBounds:function(){var bounds=new L.LatLngBounds;if(this._topClusterLevel){bounds.extend(this._topClusterLevel._bounds)}else{for(var i=this._needsClustering.length-1;i>=0;i--){bounds.extend(this._needsClustering[i].getLatLng())}}bounds.extend(this._nonPointGroup.getBounds());return bounds},eachLayer:function(method,context){var markers=this._needsClustering.slice(),i;if(this._topClusterLevel){this._topClusterLevel.getAllChildMarkers(markers)}for(i=markers.length-1;i>=0;i--){method.call(context,markers[i])}this._nonPointGroup.eachLayer(method,context)},getLayers:function(){var layers=[];this.eachLayer(function(l){layers.push(l)});return layers},hasLayer:function(layer){if(!layer){return false}var i,anArray=this._needsClustering;for(i=anArray.length-1;i>=0;i--){if(anArray[i]===layer){return true}}anArray=this._needsRemoving;for(i=anArray.length-1;i>=0;i--){if(anArray[i]===layer){return false}}return!!(layer.__parent&&layer.__parent._group===this)||this._nonPointGroup.hasLayer(layer)},zoomToShowLayer:function(layer,callback){var showMarker=function(){if((layer._icon||layer.__parent._icon)&&!this._inZoomAnimation){this._map.off("moveend",showMarker,this);this.off("animationend",showMarker,this);if(layer._icon){callback()}else if(layer.__parent._icon){var afterSpiderfy=function(){this.off("spiderfied",afterSpiderfy,this);callback()};this.on("spiderfied",afterSpiderfy,this);layer.__parent.spiderfy()}}};if(layer._icon){callback()}else if(layer.__parent._zoom<this._map.getZoom()){this._map.on("moveend",showMarker,this);if(!layer._icon){this._map.panTo(layer.getLatLng())}}else{this._map.on("moveend",showMarker,this);this.on("animationend",showMarker,this);this._map.setView(layer.getLatLng(),layer.__parent._zoom+1);layer.__parent.zoomToBounds()}},onAdd:function(map){this._map=map;var i,l,layer;if(!isFinite(this._map.getMaxZoom())){throw"Map has no maxZoom specified"}this._featureGroup.onAdd(map);this._nonPointGroup.onAdd(map);if(!this._gridClusters){this._generateInitialClusters()}for(i=0,l=this._needsRemoving.length;i<l;i++){layer=this._needsRemoving[i];this._removeLayer(layer,true)}this._needsRemoving=[];for(i=0,l=this._needsClustering.length;i<l;i++){layer=this._needsClustering[i];if(!layer.getLatLng){this._featureGroup.addLayer(layer);continue}if(layer.__parent){continue}this._addLayer(layer,this._maxZoom)}this._needsClustering=[];this._map.on("zoomend",this._zoomEnd,this);this._map.on("moveend",this._moveEnd,this);if(this._spiderfierOnAdd){this._spiderfierOnAdd()}this._bindEvents();this._zoom=this._map.getZoom();this._currentShownBounds=this._getExpandedVisibleBounds();this._topClusterLevel._recursivelyAddChildrenToMap(null,this._zoom,this._currentShownBounds)},onRemove:function(map){map.off("zoomend",this._zoomEnd,this);map.off("moveend",this._moveEnd,this);this._unbindEvents();this._map._mapPane.className=this._map._mapPane.className.replace(" leaflet-cluster-anim","");if(this._spiderfierOnRemove){this._spiderfierOnRemove()}this._hideCoverage();this._featureGroup.onRemove(map);this._nonPointGroup.onRemove(map);this._featureGroup.clearLayers();this._map=null},getVisibleParent:function(marker){var vMarker=marker;while(vMarker&&!vMarker._icon){vMarker=vMarker.__parent}return vMarker||null},_arraySplice:function(anArray,obj){for(var i=anArray.length-1;i>=0;i--){if(anArray[i]===obj){anArray.splice(i,1);return true}}},_removeLayer:function(marker,removeFromDistanceGrid,dontUpdateMap){var gridClusters=this._gridClusters,gridUnclustered=this._gridUnclustered,fg=this._featureGroup,map=this._map;if(removeFromDistanceGrid){for(var z=this._maxZoom;z>=0;z--){if(!gridUnclustered[z].removeObject(marker,map.project(marker.getLatLng(),z))){break}}}var cluster=marker.__parent,markers=cluster._markers,otherMarker;this._arraySplice(markers,marker);while(cluster){cluster._childCount--;if(cluster._zoom<0){break}else if(removeFromDistanceGrid&&cluster._childCount<=1){otherMarker=cluster._markers[0]===marker?cluster._markers[1]:cluster._markers[0];gridClusters[cluster._zoom].removeObject(cluster,map.project(cluster._cLatLng,cluster._zoom));gridUnclustered[cluster._zoom].addObject(otherMarker,map.project(otherMarker.getLatLng(),cluster._zoom));this._arraySplice(cluster.__parent._childClusters,cluster);cluster.__parent._markers.push(otherMarker);otherMarker.__parent=cluster.__parent;if(cluster._icon){fg.removeLayer(cluster);if(!dontUpdateMap){fg.addLayer(otherMarker)}}}else{cluster._recalculateBounds();if(!dontUpdateMap||!cluster._icon){cluster._updateIcon()}}cluster=cluster.__parent}delete marker.__parent},_propagateEvent:function(e){if(e.layer instanceof L.MarkerCluster){e.type="cluster"+e.type}this.fire(e.type,e)},_defaultIconCreateFunction:function(cluster){var childCount=cluster.getChildCount();var c=" marker-cluster-";if(childCount<10){c+="small"}else if(childCount<100){c+="medium"}else{c+="large"}return new L.DivIcon({html:"<div><span>"+childCount+"</span></div>",className:"marker-cluster"+c,iconSize:new L.Point(40,40)})},_bindEvents:function(){var map=this._map,spiderfyOnMaxZoom=this.options.spiderfyOnMaxZoom,showCoverageOnHover=this.options.showCoverageOnHover,zoomToBoundsOnClick=this.options.zoomToBoundsOnClick;if(spiderfyOnMaxZoom||zoomToBoundsOnClick){this.on("clusterclick",this._zoomOrSpiderfy,this)}if(showCoverageOnHover){this.on("clustermouseover",this._showCoverage,this);this.on("clustermouseout",this._hideCoverage,this);map.on("zoomend",this._hideCoverage,this)}},_zoomOrSpiderfy:function(e){var map=this._map;if(map.getMaxZoom()===map.getZoom()){if(this.options.spiderfyOnMaxZoom){e.layer.spiderfy()}}else if(this.options.zoomToBoundsOnClick){e.layer.zoomToBounds()}},_showCoverage:function(e){var map=this._map;if(this._inZoomAnimation){return}if(this._shownPolygon){map.removeLayer(this._shownPolygon)}if(e.layer.getChildCount()>2&&e.layer!==this._spiderfied){this._shownPolygon=new L.Polygon(e.layer.getConvexHull(),this.options.polygonOptions);map.addLayer(this._shownPolygon)}},_hideCoverage:function(){if(this._shownPolygon){this._map.removeLayer(this._shownPolygon);this._shownPolygon=null}},_unbindEvents:function(){var spiderfyOnMaxZoom=this.options.spiderfyOnMaxZoom,showCoverageOnHover=this.options.showCoverageOnHover,zoomToBoundsOnClick=this.options.zoomToBoundsOnClick,map=this._map;if(spiderfyOnMaxZoom||zoomToBoundsOnClick){this.off("clusterclick",this._zoomOrSpiderfy,this)}if(showCoverageOnHover){this.off("clustermouseover",this._showCoverage,this);this.off("clustermouseout",this._hideCoverage,this);map.off("zoomend",this._hideCoverage,this)}},_zoomEnd:function(){if(!this._map){return}this._mergeSplitClusters();this._zoom=this._map._zoom;this._currentShownBounds=this._getExpandedVisibleBounds()},_moveEnd:function(){if(this._inZoomAnimation){return}var newBounds=this._getExpandedVisibleBounds();this._topClusterLevel._recursivelyRemoveChildrenFromMap(this._currentShownBounds,this._zoom,newBounds);this._topClusterLevel._recursivelyAddChildrenToMap(null,this._map._zoom,newBounds);this._currentShownBounds=newBounds;return},_generateInitialClusters:function(){var maxZoom=this._map.getMaxZoom(),radius=this.options.maxClusterRadius;if(this.options.disableClusteringAtZoom){maxZoom=this.options.disableClusteringAtZoom-1}this._maxZoom=maxZoom;this._gridClusters={};this._gridUnclustered={};for(var zoom=maxZoom;zoom>=0;zoom--){this._gridClusters[zoom]=new L.DistanceGrid(radius);this._gridUnclustered[zoom]=new L.DistanceGrid(radius)}this._topClusterLevel=new L.MarkerCluster(this,-1)},_addLayer:function(layer,zoom){var gridClusters=this._gridClusters,gridUnclustered=this._gridUnclustered,markerPoint,z;if(this.options.singleMarkerMode){layer.options.icon=this.options.iconCreateFunction({getChildCount:function(){return 1},getAllChildMarkers:function(){return[layer]}})}for(;zoom>=0;zoom--){markerPoint=this._map.project(layer.getLatLng(),zoom);var closest=gridClusters[zoom].getNearObject(markerPoint);if(closest){closest._addChild(layer);layer.__parent=closest;return}closest=gridUnclustered[zoom].getNearObject(markerPoint);if(closest){var parent=closest.__parent;if(parent){this._removeLayer(closest,false)}var newCluster=new L.MarkerCluster(this,zoom,closest,layer);gridClusters[zoom].addObject(newCluster,this._map.project(newCluster._cLatLng,zoom));closest.__parent=newCluster;layer.__parent=newCluster;var lastParent=newCluster;for(z=zoom-1;z>parent._zoom;z--){lastParent=new L.MarkerCluster(this,z,lastParent);gridClusters[z].addObject(lastParent,this._map.project(closest.getLatLng(),z))}parent._addChild(lastParent);for(z=zoom;z>=0;z--){if(!gridUnclustered[z].removeObject(closest,this._map.project(closest.getLatLng(),z))){break}}return}gridUnclustered[zoom].addObject(layer,markerPoint)}this._topClusterLevel._addChild(layer);layer.__parent=this._topClusterLevel;return},_mergeSplitClusters:function(){if(this._zoom<this._map._zoom&&this._currentShownBounds.contains(this._getExpandedVisibleBounds())){this._animationStart();this._topClusterLevel._recursivelyRemoveChildrenFromMap(this._currentShownBounds,this._zoom,this._getExpandedVisibleBounds());this._animationZoomIn(this._zoom,this._map._zoom)}else if(this._zoom>this._map._zoom){this._animationStart();this._animationZoomOut(this._zoom,this._map._zoom)}else{this._moveEnd()}},_getExpandedVisibleBounds:function(){if(!this.options.removeOutsideVisibleBounds){return this.getBounds()}var map=this._map,bounds=map.getBounds(),sw=bounds._southWest,ne=bounds._northEast,latDiff=L.Browser.mobile?0:Math.abs(sw.lat-ne.lat),lngDiff=L.Browser.mobile?0:Math.abs(sw.lng-ne.lng);return new L.LatLngBounds(new L.LatLng(sw.lat-latDiff,sw.lng-lngDiff,true),new L.LatLng(ne.lat+latDiff,ne.lng+lngDiff,true))},_animationAddLayerNonAnimated:function(layer,newCluster){if(newCluster===layer){this._featureGroup.addLayer(layer)}else if(newCluster._childCount===2){newCluster._addToMap();var markers=newCluster.getAllChildMarkers();this._featureGroup.removeLayer(markers[0]);this._featureGroup.removeLayer(markers[1])}else{newCluster._updateIcon()}}});L.MarkerClusterGroup.include(!L.DomUtil.TRANSITION?{_animationStart:function(){},_animationZoomIn:function(previousZoomLevel,newZoomLevel){this._topClusterLevel._recursivelyRemoveChildrenFromMap(this._currentShownBounds,previousZoomLevel);this._topClusterLevel._recursivelyAddChildrenToMap(null,newZoomLevel,this._getExpandedVisibleBounds())},_animationZoomOut:function(previousZoomLevel,newZoomLevel){this._topClusterLevel._recursivelyRemoveChildrenFromMap(this._currentShownBounds,previousZoomLevel);this._topClusterLevel._recursivelyAddChildrenToMap(null,newZoomLevel,this._getExpandedVisibleBounds())},_animationAddLayer:function(layer,newCluster){this._animationAddLayerNonAnimated(layer,newCluster)}}:{_animationStart:function(){this._map._mapPane.className+=" leaflet-cluster-anim";this._inZoomAnimation++},_animationEnd:function(){if(this._map){this._map._mapPane.className=this._map._mapPane.className.replace(" leaflet-cluster-anim","")}this._inZoomAnimation--;this.fire("animationend")},_animationZoomIn:function(previousZoomLevel,newZoomLevel){var me=this,bounds=this._getExpandedVisibleBounds(),fg=this._featureGroup,i;this._topClusterLevel._recursively(bounds,previousZoomLevel,0,function(c){var startPos=c._latlng,markers=c._markers,m;if(!bounds.contains(startPos)){startPos=null}if(c._isSingleParent()&&previousZoomLevel+1===newZoomLevel){fg.removeLayer(c);c._recursivelyAddChildrenToMap(null,newZoomLevel,bounds)}else{c.setOpacity(0);c._recursivelyAddChildrenToMap(startPos,newZoomLevel,bounds)}for(i=markers.length-1;i>=0;i--){m=markers[i];if(!bounds.contains(m._latlng)){fg.removeLayer(m)}}});this._forceLayout();me._topClusterLevel._recursivelyBecomeVisible(bounds,newZoomLevel);fg.eachLayer(function(n){if(!(n instanceof L.MarkerCluster)&&n._icon){n.setOpacity(1)}});me._topClusterLevel._recursively(bounds,previousZoomLevel,newZoomLevel,function(c){c._recursivelyRestoreChildPositions(newZoomLevel)});setTimeout(function(){me._topClusterLevel._recursively(bounds,previousZoomLevel,0,function(c){fg.removeLayer(c);c.setOpacity(1)});me._animationEnd()},200)},_animationZoomOut:function(previousZoomLevel,newZoomLevel){this._animationZoomOutSingle(this._topClusterLevel,previousZoomLevel-1,newZoomLevel);this._topClusterLevel._recursivelyAddChildrenToMap(null,newZoomLevel,this._getExpandedVisibleBounds());this._topClusterLevel._recursivelyRemoveChildrenFromMap(this._currentShownBounds,previousZoomLevel,this._getExpandedVisibleBounds())},_animationZoomOutSingle:function(cluster,previousZoomLevel,newZoomLevel){var bounds=this._getExpandedVisibleBounds();cluster._recursivelyAnimateChildrenInAndAddSelfToMap(bounds,previousZoomLevel+1,newZoomLevel);var me=this;this._forceLayout();cluster._recursivelyBecomeVisible(bounds,newZoomLevel);setTimeout(function(){if(cluster._childCount===1){var m=cluster._markers[0];m.setLatLng(m.getLatLng());m.setOpacity(1)}else{cluster._recursively(bounds,newZoomLevel,0,function(c){c._recursivelyRemoveChildrenFromMap(bounds,previousZoomLevel+1)})}me._animationEnd()},200)},_animationAddLayer:function(layer,newCluster){var me=this,fg=this._featureGroup;fg.addLayer(layer);if(newCluster!==layer){if(newCluster._childCount>2){newCluster._updateIcon();this._forceLayout();this._animationStart();layer._setPos(this._map.latLngToLayerPoint(newCluster.getLatLng()));layer.setOpacity(0);setTimeout(function(){fg.removeLayer(layer);layer.setOpacity(1);me._animationEnd()},200)}else{this._forceLayout();me._animationStart();me._animationZoomOutSingle(newCluster,this._map.getMaxZoom(),this._map.getZoom())}}},_forceLayout:function(){L.Util.falseFn(document.body.offsetWidth)}});L.markerClusterGroup=function(options){return new L.MarkerClusterGroup(options)};L.MarkerCluster=L.Marker.extend({initialize:function(group,zoom,a,b){L.Marker.prototype.initialize.call(this,a?a._cLatLng||a.getLatLng():new L.LatLng(0,0),{icon:this});this._group=group;this._zoom=zoom;this._markers=[];this._childClusters=[];this._childCount=0;this._iconNeedsUpdate=true;this._bounds=new L.LatLngBounds;if(a){this._addChild(a)}if(b){this._addChild(b)}},getAllChildMarkers:function(storageArray){storageArray=storageArray||[];for(var i=this._childClusters.length-1;i>=0;i--){this._childClusters[i].getAllChildMarkers(storageArray)}for(var j=this._markers.length-1;j>=0;j--){storageArray.push(this._markers[j])}return storageArray},getChildCount:function(){return this._childCount},zoomToBounds:function(){var childClusters=this._childClusters.slice(),map=this._group._map,boundsZoom=map.getBoundsZoom(this._bounds),zoom=this._zoom+1,i;while(childClusters.length>0&&boundsZoom>zoom){zoom++;var newClusters=[];for(i=0;i<childClusters.length;i++){newClusters=newClusters.concat(childClusters[i]._childClusters)}childClusters=newClusters}if(boundsZoom>zoom){this._group._map.setView(this._latlng,zoom)}else{this._group._map.fitBounds(this._bounds)}},getBounds:function(){var bounds=new L.LatLngBounds;bounds.extend(this._bounds);return bounds},_updateIcon:function(){this._iconNeedsUpdate=true;if(this._icon){this.setIcon(this)}},createIcon:function(){if(this._iconNeedsUpdate){this._iconObj=this._group.options.iconCreateFunction(this);this._iconNeedsUpdate=false}return this._iconObj.createIcon()},createShadow:function(){return this._iconObj.createShadow()},_addChild:function(new1,isNotificationFromChild){this._iconNeedsUpdate=true;this._expandBounds(new1);if(new1 instanceof L.MarkerCluster){if(!isNotificationFromChild){this._childClusters.push(new1);new1.__parent=this}this._childCount+=new1._childCount}else{if(!isNotificationFromChild){this._markers.push(new1)}this._childCount++}if(this.__parent){this.__parent._addChild(new1,true)}},_expandBounds:function(marker){var addedCount,addedLatLng=marker._wLatLng||marker._latlng;if(marker instanceof L.MarkerCluster){this._bounds.extend(marker._bounds);addedCount=marker._childCount}else{this._bounds.extend(addedLatLng);addedCount=1}if(!this._cLatLng){this._cLatLng=marker._cLatLng||addedLatLng}var totalCount=this._childCount+addedCount;if(!this._wLatLng){this._latlng=this._wLatLng=new L.LatLng(addedLatLng.lat,addedLatLng.lng)}else{this._wLatLng.lat=(addedLatLng.lat*addedCount+this._wLatLng.lat*this._childCount)/totalCount;this._wLatLng.lng=(addedLatLng.lng*addedCount+this._wLatLng.lng*this._childCount)/totalCount}},_addToMap:function(startPos){if(startPos){this._backupLatlng=this._latlng;this.setLatLng(startPos)}this._group._featureGroup.addLayer(this)},_recursivelyAnimateChildrenIn:function(bounds,center,maxZoom){this._recursively(bounds,0,maxZoom-1,function(c){var markers=c._markers,i,m;for(i=markers.length-1;i>=0;i--){m=markers[i];if(m._icon){m._setPos(center);m.setOpacity(0)}}},function(c){var childClusters=c._childClusters,j,cm;for(j=childClusters.length-1;j>=0;j--){cm=childClusters[j];if(cm._icon){cm._setPos(center);cm.setOpacity(0)}}})},_recursivelyAnimateChildrenInAndAddSelfToMap:function(bounds,previousZoomLevel,newZoomLevel){this._recursively(bounds,newZoomLevel,0,function(c){c._recursivelyAnimateChildrenIn(bounds,c._group._map.latLngToLayerPoint(c.getLatLng()).round(),previousZoomLevel);if(c._isSingleParent()&&previousZoomLevel-1===newZoomLevel){c.setOpacity(1);c._recursivelyRemoveChildrenFromMap(bounds,previousZoomLevel)}else{c.setOpacity(0)}c._addToMap()})},_recursivelyBecomeVisible:function(bounds,zoomLevel){this._recursively(bounds,0,zoomLevel,null,function(c){c.setOpacity(1)})},_recursivelyAddChildrenToMap:function(startPos,zoomLevel,bounds){this._recursively(bounds,-1,zoomLevel,function(c){if(zoomLevel===c._zoom){return}for(var i=c._markers.length-1;i>=0;i--){var nm=c._markers[i];if(!bounds.contains(nm._latlng)){continue}if(startPos){nm._backupLatlng=nm.getLatLng();nm.setLatLng(startPos);if(nm.setOpacity){nm.setOpacity(0)}}c._group._featureGroup.addLayer(nm)}},function(c){c._addToMap(startPos)})},_recursivelyRestoreChildPositions:function(zoomLevel){for(var i=this._markers.length-1;i>=0;i--){var nm=this._markers[i];if(nm._backupLatlng){nm.setLatLng(nm._backupLatlng);delete nm._backupLatlng}}if(zoomLevel-1===this._zoom){for(var j=this._childClusters.length-1;j>=0;j--){this._childClusters[j]._restorePosition()}}else{for(var k=this._childClusters.length-1;k>=0;k--){this._childClusters[k]._recursivelyRestoreChildPositions(zoomLevel)}}},_restorePosition:function(){if(this._backupLatlng){this.setLatLng(this._backupLatlng);delete this._backupLatlng}},_recursivelyRemoveChildrenFromMap:function(previousBounds,zoomLevel,exceptBounds){var m,i;this._recursively(previousBounds,-1,zoomLevel-1,function(c){for(i=c._markers.length-1;i>=0;i--){m=c._markers[i];if(!exceptBounds||!exceptBounds.contains(m._latlng)){c._group._featureGroup.removeLayer(m);if(m.setOpacity){m.setOpacity(1)}}}},function(c){for(i=c._childClusters.length-1;i>=0;i--){m=c._childClusters[i];if(!exceptBounds||!exceptBounds.contains(m._latlng)){c._group._featureGroup.removeLayer(m);if(m.setOpacity){m.setOpacity(1)}}}})},_recursively:function(boundsToApplyTo,zoomLevelToStart,zoomLevelToStop,runAtEveryLevel,runAtBottomLevel){var childClusters=this._childClusters,zoom=this._zoom,i,c;if(zoomLevelToStart>zoom){for(i=childClusters.length-1;i>=0;i--){c=childClusters[i];if(boundsToApplyTo.intersects(c._bounds)){c._recursively(boundsToApplyTo,zoomLevelToStart,zoomLevelToStop,runAtEveryLevel,runAtBottomLevel)}}}else{if(runAtEveryLevel){runAtEveryLevel(this)}if(runAtBottomLevel&&this._zoom===zoomLevelToStop){runAtBottomLevel(this)}if(zoomLevelToStop>zoom){for(i=childClusters.length-1;i>=0;i--){c=childClusters[i];if(boundsToApplyTo.intersects(c._bounds)){c._recursively(boundsToApplyTo,zoomLevelToStart,zoomLevelToStop,runAtEveryLevel,runAtBottomLevel)}}}}},_recalculateBounds:function(){var markers=this._markers,childClusters=this._childClusters,i;this._bounds=new L.LatLngBounds;delete this._wLatLng;for(i=markers.length-1;i>=0;i--){this._expandBounds(markers[i])}for(i=childClusters.length-1;i>=0;i--){this._expandBounds(childClusters[i])}},_isSingleParent:function(){return this._childClusters.length>0&&this._childClusters[0]._childCount===this._childCount}});L.DistanceGrid=function(cellSize){this._cellSize=cellSize;this._sqCellSize=cellSize*cellSize;this._grid={};this._objectPoint={}};L.DistanceGrid.prototype={addObject:function(obj,point){var x=this._getCoord(point.x),y=this._getCoord(point.y),grid=this._grid,row=grid[y]=grid[y]||{},cell=row[x]=row[x]||[],stamp=L.Util.stamp(obj);this._objectPoint[stamp]=point;cell.push(obj)},updateObject:function(obj,point){this.removeObject(obj);this.addObject(obj,point)},removeObject:function(obj,point){var x=this._getCoord(point.x),y=this._getCoord(point.y),grid=this._grid,row=grid[y]=grid[y]||{},cell=row[x]=row[x]||[],i,len;delete this._objectPoint[L.Util.stamp(obj)];for(i=0,len=cell.length;i<len;i++){if(cell[i]===obj){cell.splice(i,1);if(len===1){delete row[x]}return true}}},eachObject:function(fn,context){var i,j,k,len,row,cell,removed,grid=this._grid;for(i in grid){row=grid[i];for(j in row){cell=row[j];for(k=0,len=cell.length;k<len;k++){removed=fn.call(context,cell[k]);if(removed){k--;len--}}}}},getNearObject:function(point){var x=this._getCoord(point.x),y=this._getCoord(point.y),i,j,k,row,cell,len,obj,dist,objectPoint=this._objectPoint,closestDistSq=this._sqCellSize,closest=null;for(i=y-1;i<=y+1;i++){row=this._grid[i];if(row){for(j=x-1;j<=x+1;j++){cell=row[j];if(cell){for(k=0,len=cell.length;k<len;k++){obj=cell[k];dist=this._sqDist(objectPoint[L.Util.stamp(obj)],point);if(dist<closestDistSq){closestDistSq=dist;closest=obj}}}}}}return closest},_getCoord:function(x){return Math.floor(x/this._cellSize)},_sqDist:function(p,p2){var dx=p2.x-p.x,dy=p2.y-p.y;return dx*dx+dy*dy}};(function(){L.QuickHull={getDistant:function(cpt,bl){var vY=bl[1].lat-bl[0].lat,vX=bl[0].lng-bl[1].lng;return vX*(cpt.lat-bl[0].lat)+vY*(cpt.lng-bl[0].lng)},findMostDistantPointFromBaseLine:function(baseLine,latLngs){var maxD=0,maxPt=null,newPoints=[],i,pt,d;for(i=latLngs.length-1;i>=0;i--){pt=latLngs[i];d=this.getDistant(pt,baseLine);if(d>0){newPoints.push(pt)}else{continue}if(d>maxD){maxD=d;maxPt=pt}}return{maxPoint:maxPt,newPoints:newPoints}},buildConvexHull:function(baseLine,latLngs){var convexHullBaseLines=[],t=this.findMostDistantPointFromBaseLine(baseLine,latLngs);if(t.maxPoint){convexHullBaseLines=convexHullBaseLines.concat(this.buildConvexHull([baseLine[0],t.maxPoint],t.newPoints));convexHullBaseLines=convexHullBaseLines.concat(this.buildConvexHull([t.maxPoint,baseLine[1]],t.newPoints));return convexHullBaseLines}else{return[baseLine[0]]}},getConvexHull:function(latLngs){var maxLat=false,minLat=false,maxPt=null,minPt=null,i;for(i=latLngs.length-1;i>=0;i--){var pt=latLngs[i];if(maxLat===false||pt.lat>maxLat){maxPt=pt;maxLat=pt.lat}if(minLat===false||pt.lat<minLat){minPt=pt;minLat=pt.lat}}var ch=[].concat(this.buildConvexHull([minPt,maxPt],latLngs),this.buildConvexHull([maxPt,minPt],latLngs));return ch}}})();L.MarkerCluster.include({getConvexHull:function(){var childMarkers=this.getAllChildMarkers(),points=[],p,i;for(i=childMarkers.length-1;i>=0;i--){p=childMarkers[i].getLatLng();points.push(p)}return L.QuickHull.getConvexHull(points)}});L.MarkerCluster.include({_2PI:Math.PI*2,_circleFootSeparation:25,_circleStartAngle:Math.PI/6,_spiralFootSeparation:28,_spiralLengthStart:11,_spiralLengthFactor:5,_circleSpiralSwitchover:9,spiderfy:function(){if(this._group._spiderfied===this||this._group._inZoomAnimation){return}var childMarkers=this.getAllChildMarkers(),group=this._group,map=group._map,center=map.latLngToLayerPoint(this._latlng),positions;this._group._unspiderfy();this._group._spiderfied=this;if(childMarkers.length>=this._circleSpiralSwitchover){positions=this._generatePointsSpiral(childMarkers.length,center)}else{center.y+=10;positions=this._generatePointsCircle(childMarkers.length,center)}this._animationSpiderfy(childMarkers,positions)},unspiderfy:function(zoomDetails){if(this._group._inZoomAnimation){return}this._animationUnspiderfy(zoomDetails);this._group._spiderfied=null},_generatePointsCircle:function(count,centerPt){var circumference=this._group.options.spiderfyDistanceMultiplier*this._circleFootSeparation*(2+count),legLength=circumference/this._2PI,angleStep=this._2PI/count,res=[],i,angle;res.length=count;for(i=count-1;i>=0;i--){angle=this._circleStartAngle+i*angleStep;res[i]=new L.Point(centerPt.x+legLength*Math.cos(angle),centerPt.y+legLength*Math.sin(angle))._round()}return res},_generatePointsSpiral:function(count,centerPt){var legLength=this._group.options.spiderfyDistanceMultiplier*this._spiralLengthStart,separation=this._group.options.spiderfyDistanceMultiplier*this._spiralFootSeparation,lengthFactor=this._group.options.spiderfyDistanceMultiplier*this._spiralLengthFactor,angle=0,res=[],i;res.length=count;for(i=count-1;i>=0;i--){angle+=separation/legLength+i*5e-4;res[i]=new L.Point(centerPt.x+legLength*Math.cos(angle),centerPt.y+legLength*Math.sin(angle))._round();legLength+=this._2PI*lengthFactor/angle}return res},_noanimationUnspiderfy:function(){var group=this._group,map=group._map,fg=group._featureGroup,childMarkers=this.getAllChildMarkers(),m,i;this.setOpacity(1);for(i=childMarkers.length-1;i>=0;i--){m=childMarkers[i];fg.removeLayer(m);if(m._preSpiderfyLatlng){m.setLatLng(m._preSpiderfyLatlng);delete m._preSpiderfyLatlng}if(m.setZIndexOffset){m.setZIndexOffset(0)}if(m._spiderLeg){map.removeLayer(m._spiderLeg);delete m._spiderLeg}}group._spiderfied=null}});L.MarkerCluster.include(!L.DomUtil.TRANSITION?{_animationSpiderfy:function(childMarkers,positions){var group=this._group,map=group._map,fg=group._featureGroup,i,m,leg,newPos;for(i=childMarkers.length-1;i>=0;i--){newPos=map.layerPointToLatLng(positions[i]);m=childMarkers[i];m._preSpiderfyLatlng=m._latlng;m.setLatLng(newPos);if(m.setZIndexOffset){m.setZIndexOffset(1e6)}fg.addLayer(m);leg=new L.Polyline([this._latlng,newPos],{weight:1.5,color:"#222"});map.addLayer(leg);m._spiderLeg=leg}this.setOpacity(.3);group.fire("spiderfied")},_animationUnspiderfy:function(){this._noanimationUnspiderfy()}}:{SVG_ANIMATION:function(){return document.createElementNS("http://www.w3.org/2000/svg","animate").toString().indexOf("SVGAnimate")>-1}(),_animationSpiderfy:function(childMarkers,positions){var me=this,group=this._group,map=group._map,fg=group._featureGroup,thisLayerPos=map.latLngToLayerPoint(this._latlng),i,m,leg,newPos;for(i=childMarkers.length-1;i>=0;i--){m=childMarkers[i];if(m.setOpacity){m.setZIndexOffset(1e6);m.setOpacity(0);fg.addLayer(m);m._setPos(thisLayerPos)}else{fg.addLayer(m)}}group._forceLayout();group._animationStart();var initialLegOpacity=L.Path.SVG?0:.3,xmlns=L.Path.SVG_NS;for(i=childMarkers.length-1;i>=0;i--){newPos=map.layerPointToLatLng(positions[i]);m=childMarkers[i];m._preSpiderfyLatlng=m._latlng;m.setLatLng(newPos);if(m.setOpacity){m.setOpacity(1)}leg=new L.Polyline([me._latlng,newPos],{weight:1.5,color:"#222",opacity:initialLegOpacity});map.addLayer(leg);m._spiderLeg=leg;if(!L.Path.SVG||!this.SVG_ANIMATION){continue}var length=leg._path.getTotalLength();leg._path.setAttribute("stroke-dasharray",length+","+length);var anim=document.createElementNS(xmlns,"animate");anim.setAttribute("attributeName","stroke-dashoffset");anim.setAttribute("begin","indefinite");anim.setAttribute("from",length);anim.setAttribute("to",0);anim.setAttribute("dur",.25);leg._path.appendChild(anim);anim.beginElement();anim=document.createElementNS(xmlns,"animate");anim.setAttribute("attributeName","stroke-opacity");anim.setAttribute("attributeName","stroke-opacity");anim.setAttribute("begin","indefinite");anim.setAttribute("from",0);anim.setAttribute("to",.5);anim.setAttribute("dur",.25);leg._path.appendChild(anim);anim.beginElement()}me.setOpacity(.3);if(L.Path.SVG){this._group._forceLayout();for(i=childMarkers.length-1;i>=0;i--){m=childMarkers[i]._spiderLeg;m.options.opacity=.5;m._path.setAttribute("stroke-opacity",.5)}}setTimeout(function(){group._animationEnd();group.fire("spiderfied")},200)},_animationUnspiderfy:function(zoomDetails){
var group=this._group,map=group._map,fg=group._featureGroup,thisLayerPos=zoomDetails?map._latLngToNewLayerPoint(this._latlng,zoomDetails.zoom,zoomDetails.center):map.latLngToLayerPoint(this._latlng),childMarkers=this.getAllChildMarkers(),svg=L.Path.SVG&&this.SVG_ANIMATION,m,i,a;group._animationStart();this.setOpacity(1);for(i=childMarkers.length-1;i>=0;i--){m=childMarkers[i];if(!m._preSpiderfyLatlng){continue}m.setLatLng(m._preSpiderfyLatlng);delete m._preSpiderfyLatlng;if(m.setOpacity){m._setPos(thisLayerPos);m.setOpacity(0)}else{fg.removeLayer(m)}if(svg){a=m._spiderLeg._path.childNodes[0];a.setAttribute("to",a.getAttribute("from"));a.setAttribute("from",0);a.beginElement();a=m._spiderLeg._path.childNodes[1];a.setAttribute("from",.5);a.setAttribute("to",0);a.setAttribute("stroke-opacity",0);a.beginElement();m._spiderLeg._path.setAttribute("stroke-opacity",0)}}setTimeout(function(){var stillThereChildCount=0;for(i=childMarkers.length-1;i>=0;i--){m=childMarkers[i];if(m._spiderLeg){stillThereChildCount++}}for(i=childMarkers.length-1;i>=0;i--){m=childMarkers[i];if(!m._spiderLeg){continue}if(m.setOpacity){m.setOpacity(1);m.setZIndexOffset(0)}if(stillThereChildCount>1){fg.removeLayer(m)}map.removeLayer(m._spiderLeg);delete m._spiderLeg}group._animationEnd()},200)}});L.MarkerClusterGroup.include({_spiderfied:null,_spiderfierOnAdd:function(){this._map.on("click",this._unspiderfyWrapper,this);if(this._map.options.zoomAnimation){this._map.on("zoomstart",this._unspiderfyZoomStart,this)}this._map.on("zoomend",this._noanimationUnspiderfy,this);if(L.Path.SVG&&!L.Browser.touch){this._map._initPathRoot()}},_spiderfierOnRemove:function(){this._map.off("click",this._unspiderfyWrapper,this);this._map.off("zoomstart",this._unspiderfyZoomStart,this);this._map.off("zoomanim",this._unspiderfyZoomAnim,this);this._unspiderfy()},_unspiderfyZoomStart:function(){if(!this._map){return}this._map.on("zoomanim",this._unspiderfyZoomAnim,this)},_unspiderfyZoomAnim:function(zoomDetails){if(L.DomUtil.hasClass(this._map._mapPane,"leaflet-touching")){return}this._map.off("zoomanim",this._unspiderfyZoomAnim,this);this._unspiderfy(zoomDetails)},_unspiderfyWrapper:function(){this._unspiderfy()},_unspiderfy:function(zoomDetails){if(this._spiderfied){this._spiderfied.unspiderfy(zoomDetails)}},_noanimationUnspiderfy:function(){if(this._spiderfied){this._spiderfied._noanimationUnspiderfy()}},_unspiderfyLayer:function(layer){if(layer._spiderLeg){this._featureGroup.removeLayer(layer);layer.setOpacity(1);layer.setZIndexOffset(0);this._map.removeLayer(layer._spiderLeg);delete layer._spiderLeg}}})})(window,document);!function(){"use strict";function t(i){return this instanceof t?(this._canvas=i="string"==typeof i?document.getElementById(i):i,this._ctx=i.getContext("2d"),this._width=i.width,this._height=i.height,this._max=1,void this.clear()):new t(i)}t.prototype={defaultRadius:25,defaultGradient:{.4:"blue",.6:"cyan",.7:"lime",.8:"yellow",1:"red"},data:function(t){return this._data=t,this},max:function(t){return this._max=t,this},add:function(t){return this._data.push(t),this},clear:function(){return this._data=[],this},radius:function(t,i){i=i||15;var a=this._circle=document.createElement("canvas"),s=a.getContext("2d"),e=this._r=t+i;return a.width=a.height=2*e,s.shadowOffsetX=s.shadowOffsetY=200,s.shadowBlur=i,s.shadowColor="black",s.beginPath(),s.arc(e-200,e-200,t,0,2*Math.PI,!0),s.closePath(),s.fill(),this},gradient:function(t){var i=document.createElement("canvas"),a=i.getContext("2d"),s=a.createLinearGradient(0,0,0,256);i.width=1,i.height=256;for(var e in t)s.addColorStop(e,t[e]);return a.fillStyle=s,a.fillRect(0,0,1,256),this._grad=a.getImageData(0,0,1,256).data,this},draw:function(t){this._circle||this.radius(this.defaultRadius),this._grad||this.gradient(this.defaultGradient);var i=this._ctx;i.clearRect(0,0,this._width,this._height);for(var a,s=0,e=this._data.length;e>s;s++)a=this._data[s],i.globalAlpha=Math.max(a[2]/this._max,t||.05),i.drawImage(this._circle,a[0]-this._r,a[1]-this._r);var n=i.getImageData(0,0,this._width,this._height);return this._colorize(n.data,this._grad),i.putImageData(n,0,0),this},_colorize:function(t,i){for(var a,s=3,e=t.length;e>s;s+=4)a=4*t[s],a&&(t[s-3]=i[a],t[s-2]=i[a+1],t[s-1]=i[a+2])}},window.simpleheat=t}(),L.HeatLayer=(L.Layer?L.Layer:L.Class).extend({initialize:function(t,i){this._latlngs=t,L.setOptions(this,i)},setLatLngs:function(t){return this._latlngs=t,this.redraw()},addLatLng:function(t){return this._latlngs.push(t),this.redraw()},setOptions:function(t){return L.setOptions(this,t),this._heat&&this._updateOptions(),this.redraw()},redraw:function(){return!this._heat||this._frame||this._map._animating||(this._frame=L.Util.requestAnimFrame(this._redraw,this)),this},onAdd:function(t){this._map=t,this._canvas||this._initCanvas(),t._panes.overlayPane.appendChild(this._canvas),t.on("moveend",this._reset,this),t.options.zoomAnimation&&L.Browser.any3d&&t.on("zoomanim",this._animateZoom,this),this._reset()},onRemove:function(t){t.getPanes().overlayPane.removeChild(this._canvas),t.off("moveend",this._reset,this),t.options.zoomAnimation&&t.off("zoomanim",this._animateZoom,this)},addTo:function(t){return t.addLayer(this),this},_initCanvas:function(){var t=this._canvas=L.DomUtil.create("canvas","leaflet-heatmap-layer leaflet-layer"),i=this._map.getSize();t.width=i.x,t.height=i.y;var a=this._map.options.zoomAnimation&&L.Browser.any3d;L.DomUtil.addClass(t,"leaflet-zoom-"+(a?"animated":"hide")),this._heat=simpleheat(t),this._updateOptions()},_updateOptions:function(){this._heat.radius(this.options.radius||this._heat.defaultRadius,this.options.blur),this.options.gradient&&this._heat.gradient(this.options.gradient),this.options.max&&this._heat.max(this.options.max)},_reset:function(){var t=this._map.containerPointToLayerPoint([0,0]);L.DomUtil.setPosition(this._canvas,t);var i=this._map.getSize();this._heat._width!==i.x&&(this._canvas.width=this._heat._width=i.x),this._heat._height!==i.y&&(this._canvas.height=this._heat._height=i.y),this._redraw()},_redraw:function(){var t,i,a,s,e,n,h,o,r,_=[],d=this._heat._r,l=this._map.getSize(),m=new L.LatLngBounds(this._map.containerPointToLatLng(L.point([-d,-d])),this._map.containerPointToLatLng(l.add([d,d]))),c=void 0===this.options.maxZoom?this._map.getMaxZoom():this.options.maxZoom,u=1/Math.pow(2,Math.max(0,Math.min(c-this._map.getZoom(),12))),g=d/2,f=[],p=this._map._getMapPanePos(),v=p.x%g,w=p.y%g;for(t=0,i=this._latlngs.length;i>t;t++)if(m.contains(this._latlngs[t])){a=this._map.latLngToContainerPoint(this._latlngs[t]),e=Math.floor((a.x-v)/g)+2,n=Math.floor((a.y-w)/g)+2;var y=void 0!==this._latlngs[t].alt?this._latlngs[t].alt:void 0!==this._latlngs[t][2]?+this._latlngs[t][2]:1;r=y*u,f[n]=f[n]||[],s=f[n][e],s?(s[0]=(s[0]*s[2]+a.x*r)/(s[2]+r),s[1]=(s[1]*s[2]+a.y*r)/(s[2]+r),s[2]+=r):f[n][e]=[a.x,a.y,r]}for(t=0,i=f.length;i>t;t++)if(f[t])for(h=0,o=f[t].length;o>h;h++)s=f[t][h],s&&_.push([Math.round(s[0]),Math.round(s[1]),Math.min(s[2],1)]);this._heat.data(_).draw(this.options.minOpacity),this._frame=null},_animateZoom:function(t){var i=this._map.getZoomScale(t.zoom),a=this._map._getCenterOffset(t.center)._multiplyBy(-i).subtract(this._map._getMapPanePos());L.DomUtil.setTransform?L.DomUtil.setTransform(this._canvas,a,i):this._canvas.style[L.DomUtil.TRANSFORM]=L.DomUtil.getTranslateString(a)+" scale("+i+")"}}),L.heatLayer=function(t,i){return new L.HeatLayer(t,i)};(function(window,document,undefined){L.drawVersion="0.2.4-dev";L.drawLocal={draw:{toolbar:{actions:{title:"Cancel drawing",text:"Cancel"},finish:{title:"Finish drawing",text:"Finish"},undo:{title:"Delete last point drawn",text:"Delete last point"},buttons:{polyline:"Draw a polyline",polygon:"Draw a polygon",rectangle:"Draw a rectangle",circle:"Draw a circle",marker:"Draw a marker"}},handlers:{circle:{tooltip:{start:"Click and drag to draw circle."},radius:"Radius"},marker:{tooltip:{start:"Click map to place marker."}},polygon:{tooltip:{start:"Click to start drawing shape.",cont:"Click to continue drawing shape.",end:"Click first point to close this shape."}},polyline:{error:"<strong>Error:</strong> shape edges cannot cross!",tooltip:{start:"Click to start drawing line.",cont:"Click to continue drawing line.",end:"Click last point to finish line."}},rectangle:{tooltip:{start:"Click and drag to draw rectangle."}},simpleshape:{tooltip:{end:"Release mouse to finish drawing."}}}},edit:{toolbar:{actions:{save:{title:"Save changes.",text:"Save"},cancel:{title:"Cancel editing, discards all changes.",text:"Cancel"}},buttons:{edit:"Edit layers.",editDisabled:"No layers to edit.",remove:"Delete layers.",removeDisabled:"No layers to delete."}},handlers:{edit:{tooltip:{text:"Drag handles, or marker to edit feature.",subtext:"Click cancel to undo changes."}},remove:{tooltip:{text:"Click on a feature to remove"}}}}};L.Draw={};L.Draw.Feature=L.Handler.extend({includes:L.Mixin.Events,initialize:function(map,options){this._map=map;this._container=map._container;this._overlayPane=map._panes.overlayPane;this._popupPane=map._panes.popupPane;if(options&&options.shapeOptions){options.shapeOptions=L.Util.extend({},this.options.shapeOptions,options.shapeOptions)}L.setOptions(this,options)},enable:function(){if(this._enabled){return}L.Handler.prototype.enable.call(this);this.fire("enabled",{handler:this.type});this._map.fire("draw:drawstart",{layerType:this.type})},disable:function(){if(!this._enabled){return}L.Handler.prototype.disable.call(this);this._map.fire("draw:drawstop",{layerType:this.type});this.fire("disabled",{handler:this.type})},addHooks:function(){var map=this._map;if(map){L.DomUtil.disableTextSelection();map.getContainer().focus();this._tooltip=new L.Tooltip(this._map);L.DomEvent.on(this._container,"keyup",this._cancelDrawing,this)}},removeHooks:function(){if(this._map){L.DomUtil.enableTextSelection();this._tooltip.dispose();this._tooltip=null;L.DomEvent.off(this._container,"keyup",this._cancelDrawing,this)}},setOptions:function(options){L.setOptions(this,options)},_fireCreatedEvent:function(layer){this._map.fire("draw:created",{layer:layer,layerType:this.type})},_cancelDrawing:function(e){if(e.keyCode===27){this.disable()}}});L.Draw.Polyline=L.Draw.Feature.extend({statics:{TYPE:"polyline"},Poly:L.Polyline,options:{allowIntersection:true,repeatMode:false,drawError:{color:"#b00b00",timeout:2500},icon:new L.DivIcon({iconSize:new L.Point(8,8),className:"leaflet-div-icon leaflet-editing-icon"}),touchIcon:new L.DivIcon({iconSize:new L.Point(20,20),className:"leaflet-div-icon leaflet-editing-icon leaflet-touch-icon"}),guidelineDistance:20,maxGuideLineLength:4e3,shapeOptions:{stroke:true,color:"#f06eaa",weight:4,opacity:.5,fill:false,clickable:true},metric:true,showLength:true,zIndexOffset:2e3},initialize:function(map,options){if(L.Browser.touch){this.options.icon=this.options.touchIcon}this.options.drawError.message=L.drawLocal.draw.handlers.polyline.error;if(options&&options.drawError){options.drawError=L.Util.extend({},this.options.drawError,options.drawError)}this.type=L.Draw.Polyline.TYPE;L.Draw.Feature.prototype.initialize.call(this,map,options)},addHooks:function(){L.Draw.Feature.prototype.addHooks.call(this);if(this._map){this._markers=[];this._markerGroup=new L.LayerGroup;this._map.addLayer(this._markerGroup);this._poly=new L.Polyline([],this.options.shapeOptions);this._tooltip.updateContent(this._getTooltipText());if(!this._mouseMarker){this._mouseMarker=L.marker(this._map.getCenter(),{icon:L.divIcon({className:"leaflet-mouse-marker",iconAnchor:[20,20],iconSize:[40,40]}),opacity:0,zIndexOffset:this.options.zIndexOffset})}this._mouseMarker.on("mousedown",this._onMouseDown,this).addTo(this._map);this._map.on("mousemove",this._onMouseMove,this).on("mouseup",this._onMouseUp,this).on("zoomlevelschange",this._onZoomChange,this).on("click",this._onTouch,this)}},removeHooks:function(){L.Draw.Feature.prototype.removeHooks.call(this);this._clearHideErrorTimeout();this._cleanUpShape();this._map.removeLayer(this._markerGroup);delete this._markerGroup;delete this._markers;this._map.removeLayer(this._poly);delete this._poly;this._mouseMarker.off("mousedown",this._onMouseDown,this).off("mouseup",this._onMouseUp,this);this._map.removeLayer(this._mouseMarker);delete this._mouseMarker;this._clearGuides();this._map.off("mousemove",this._onMouseMove,this).off("mouseup",this._onMouseUp,this).off("zoomlevelschange",this._onZoomChange,this).off("click",this._onTouch,this)},deleteLastVertex:function(){if(this._markers.length<=1){return}var lastMarker=this._markers.pop(),poly=this._poly,latlng=this._poly.spliceLatLngs(poly.getLatLngs().length-1,1)[0];this._markerGroup.removeLayer(lastMarker);if(poly.getLatLngs().length<2){this._map.removeLayer(poly)}this._vertexChanged(latlng,false)},addVertex:function(latlng){var markersLength=this._markers.length;if(markersLength>0&&!this.options.allowIntersection&&this._poly.newLatLngIntersects(latlng)){this._showErrorTooltip();return}else if(this._errorShown){this._hideErrorTooltip()}this._markers.push(this._createMarker(latlng));this._poly.addLatLng(latlng);if(this._poly.getLatLngs().length===2){this._map.addLayer(this._poly)}this._vertexChanged(latlng,true)},completeShape:function(){if(this._markers.length<=1){return}this._fireCreatedEvent();this.disable();if(this.options.repeatMode){this.enable()}},_finishShape:function(){var intersects=this._poly.newLatLngIntersects(this._poly.getLatLngs()[0],true);if(!this.options.allowIntersection&&intersects||!this._shapeIsValid()){this._showErrorTooltip();return}this._fireCreatedEvent();this.disable();if(this.options.repeatMode){this.enable()}},_shapeIsValid:function(){return true},_onZoomChange:function(){this._updateGuide()},_onMouseMove:function(e){var newPos=e.layerPoint,latlng=e.latlng;this._currentLatLng=latlng;this._updateTooltip(latlng);this._updateGuide(newPos);this._mouseMarker.setLatLng(latlng);L.DomEvent.preventDefault(e.originalEvent)},_onMouseDown:function(e){var originalEvent=e.originalEvent;this._mouseDownOrigin=L.point(originalEvent.clientX,originalEvent.clientY)},_onMouseUp:function(e){if(this._mouseDownOrigin){var distance=L.point(e.originalEvent.clientX,e.originalEvent.clientY).distanceTo(this._mouseDownOrigin);if(Math.abs(distance)<9*(window.devicePixelRatio||1)){this.addVertex(e.latlng)}}this._mouseDownOrigin=null},_onTouch:function(e){if(L.Browser.touch){this._onMouseMove(e);this._onMouseDown(e);this._onMouseUp(e)}},_vertexChanged:function(latlng,added){this._updateFinishHandler();this._updateRunningMeasure(latlng,added);this._clearGuides();this._updateTooltip()},_updateFinishHandler:function(){var markerCount=this._markers.length;if(markerCount>1){this._markers[markerCount-1].on("click",this._finishShape,this)}if(markerCount>2){this._markers[markerCount-2].off("click",this._finishShape,this)}},_createMarker:function(latlng){var marker=new L.Marker(latlng,{icon:this.options.icon,zIndexOffset:this.options.zIndexOffset*2});this._markerGroup.addLayer(marker);return marker},_updateGuide:function(newPos){var markerCount=this._markers.length;if(markerCount>0){newPos=newPos||this._map.latLngToLayerPoint(this._currentLatLng);this._clearGuides();this._drawGuide(this._map.latLngToLayerPoint(this._markers[markerCount-1].getLatLng()),newPos)}},_updateTooltip:function(latLng){var text=this._getTooltipText();if(latLng){this._tooltip.updatePosition(latLng)}if(!this._errorShown){this._tooltip.updateContent(text)}},_drawGuide:function(pointA,pointB){var length=Math.floor(Math.sqrt(Math.pow(pointB.x-pointA.x,2)+Math.pow(pointB.y-pointA.y,2))),guidelineDistance=this.options.guidelineDistance,maxGuideLineLength=this.options.maxGuideLineLength,i=length>maxGuideLineLength?length-maxGuideLineLength:guidelineDistance,fraction,dashPoint,dash;if(!this._guidesContainer){this._guidesContainer=L.DomUtil.create("div","leaflet-draw-guides",this._overlayPane)}for(;i<length;i+=this.options.guidelineDistance){fraction=i/length;dashPoint={x:Math.floor(pointA.x*(1-fraction)+fraction*pointB.x),y:Math.floor(pointA.y*(1-fraction)+fraction*pointB.y)};dash=L.DomUtil.create("div","leaflet-draw-guide-dash",this._guidesContainer);dash.style.backgroundColor=!this._errorShown?this.options.shapeOptions.color:this.options.drawError.color;L.DomUtil.setPosition(dash,dashPoint)}},_updateGuideColor:function(color){if(this._guidesContainer){for(var i=0,l=this._guidesContainer.childNodes.length;i<l;i++){this._guidesContainer.childNodes[i].style.backgroundColor=color}}},_clearGuides:function(){if(this._guidesContainer){while(this._guidesContainer.firstChild){this._guidesContainer.removeChild(this._guidesContainer.firstChild)}}},_getTooltipText:function(){var showLength=this.options.showLength,labelText,distanceStr;if(this._markers.length===0){labelText={text:L.drawLocal.draw.handlers.polyline.tooltip.start}}else{distanceStr=showLength?this._getMeasurementString():"";if(this._markers.length===1){labelText={text:L.drawLocal.draw.handlers.polyline.tooltip.cont,subtext:distanceStr}}else{labelText={text:L.drawLocal.draw.handlers.polyline.tooltip.end,subtext:distanceStr}}}return labelText},_updateRunningMeasure:function(latlng,added){var markersLength=this._markers.length,previousMarkerIndex,distance;if(this._markers.length===1){this._measurementRunningTotal=0}else{previousMarkerIndex=markersLength-(added?2:1);distance=latlng.distanceTo(this._markers[previousMarkerIndex].getLatLng());this._measurementRunningTotal+=distance*(added?1:-1)}},_getMeasurementString:function(){var currentLatLng=this._currentLatLng,previousLatLng=this._markers[this._markers.length-1].getLatLng(),distance;distance=this._measurementRunningTotal+currentLatLng.distanceTo(previousLatLng);return L.GeometryUtil.readableDistance(distance,this.options.metric)},_showErrorTooltip:function(){this._errorShown=true;this._tooltip.showAsError().updateContent({text:this.options.drawError.message});this._updateGuideColor(this.options.drawError.color);this._poly.setStyle({color:this.options.drawError.color});this._clearHideErrorTimeout();this._hideErrorTimeout=setTimeout(L.Util.bind(this._hideErrorTooltip,this),this.options.drawError.timeout)},_hideErrorTooltip:function(){this._errorShown=false;this._clearHideErrorTimeout();this._tooltip.removeError().updateContent(this._getTooltipText());this._updateGuideColor(this.options.shapeOptions.color);this._poly.setStyle({color:this.options.shapeOptions.color})},_clearHideErrorTimeout:function(){if(this._hideErrorTimeout){clearTimeout(this._hideErrorTimeout);this._hideErrorTimeout=null}},_cleanUpShape:function(){if(this._markers.length>1){this._markers[this._markers.length-1].off("click",this._finishShape,this)}},_fireCreatedEvent:function(){var poly=new this.Poly(this._poly.getLatLngs(),this.options.shapeOptions);L.Draw.Feature.prototype._fireCreatedEvent.call(this,poly)}});L.Draw.Polygon=L.Draw.Polyline.extend({statics:{TYPE:"polygon"},Poly:L.Polygon,options:{showArea:false,shapeOptions:{stroke:true,color:"#f06eaa",weight:4,opacity:.5,fill:true,fillColor:null,fillOpacity:.2,clickable:true}},initialize:function(map,options){L.Draw.Polyline.prototype.initialize.call(this,map,options);this.type=L.Draw.Polygon.TYPE},_updateFinishHandler:function(){var markerCount=this._markers.length;if(markerCount===1){this._markers[0].on("click",this._finishShape,this)}if(markerCount>2){this._markers[markerCount-1].on("dblclick",this._finishShape,this);if(markerCount>3){this._markers[markerCount-2].off("dblclick",this._finishShape,this)}}},_getTooltipText:function(){var text,subtext;if(this._markers.length===0){text=L.drawLocal.draw.handlers.polygon.tooltip.start}else if(this._markers.length<3){text=L.drawLocal.draw.handlers.polygon.tooltip.cont}else{text=L.drawLocal.draw.handlers.polygon.tooltip.end;subtext=this._getMeasurementString()}return{text:text,subtext:subtext}},_getMeasurementString:function(){var area=this._area;if(!area){return null}return L.GeometryUtil.readableArea(area,this.options.metric)},_shapeIsValid:function(){return this._markers.length>=3},_vertexChanged:function(latlng,added){var latLngs;if(!this.options.allowIntersection&&this.options.showArea){latLngs=this._poly.getLatLngs();this._area=L.GeometryUtil.geodesicArea(latLngs)}L.Draw.Polyline.prototype._vertexChanged.call(this,latlng,added)},_cleanUpShape:function(){var markerCount=this._markers.length;if(markerCount>0){this._markers[0].off("click",this._finishShape,this);if(markerCount>2){this._markers[markerCount-1].off("dblclick",this._finishShape,this)}}}});L.SimpleShape={};L.Draw.SimpleShape=L.Draw.Feature.extend({options:{repeatMode:false},initialize:function(map,options){this._endLabelText=L.drawLocal.draw.handlers.simpleshape.tooltip.end;L.Draw.Feature.prototype.initialize.call(this,map,options)},addHooks:function(){L.Draw.Feature.prototype.addHooks.call(this);if(this._map){this._mapDraggable=this._map.dragging.enabled();if(this._mapDraggable){this._map.dragging.disable()}this._container.style.cursor="crosshair";this._tooltip.updateContent({text:this._initialLabelText});this._map.on("mousedown",this._onMouseDown,this).on("mousemove",this._onMouseMove,this).on("touchstart",this._onMouseDown,this).on("touchmove",this._onMouseMove,this)}},removeHooks:function(){L.Draw.Feature.prototype.removeHooks.call(this);if(this._map){if(this._mapDraggable){this._map.dragging.enable()}this._container.style.cursor="";this._map.off("mousedown",this._onMouseDown,this).off("mousemove",this._onMouseMove,this).off("touchstart",this._onMouseDown,this).off("touchmove",this._onMouseMove,this);L.DomEvent.off(document,"mouseup",this._onMouseUp,this);L.DomEvent.off(document,"touchend",this._onMouseUp,this);if(this._shape){this._map.removeLayer(this._shape);delete this._shape}}this._isDrawing=false},_getTooltipText:function(){return{text:this._endLabelText}},_onMouseDown:function(e){this._isDrawing=true;this._startLatLng=e.latlng;L.DomEvent.on(document,"mouseup",this._onMouseUp,this).on(document,"touchend",this._onMouseUp,this).preventDefault(e.originalEvent)},_onMouseMove:function(e){var latlng=e.latlng;this._tooltip.updatePosition(latlng);if(this._isDrawing){this._tooltip.updateContent(this._getTooltipText());this._drawShape(latlng)}},_onMouseUp:function(){if(this._shape){this._fireCreatedEvent()}this.disable();if(this.options.repeatMode){this.enable()}}});L.Draw.Rectangle=L.Draw.SimpleShape.extend({statics:{TYPE:"rectangle"},options:{shapeOptions:{stroke:true,color:"#f06eaa",weight:4,opacity:.5,fill:true,fillColor:null,fillOpacity:.2,clickable:true},metric:true},initialize:function(map,options){this.type=L.Draw.Rectangle.TYPE;this._initialLabelText=L.drawLocal.draw.handlers.rectangle.tooltip.start;L.Draw.SimpleShape.prototype.initialize.call(this,map,options)},_drawShape:function(latlng){if(!this._shape){this._shape=new L.Rectangle(new L.LatLngBounds(this._startLatLng,latlng),this.options.shapeOptions);this._map.addLayer(this._shape)}else{this._shape.setBounds(new L.LatLngBounds(this._startLatLng,latlng))}},_fireCreatedEvent:function(){var rectangle=new L.Rectangle(this._shape.getBounds(),this.options.shapeOptions);L.Draw.SimpleShape.prototype._fireCreatedEvent.call(this,rectangle)},_getTooltipText:function(){var tooltipText=L.Draw.SimpleShape.prototype._getTooltipText.call(this),shape=this._shape,latLngs,area,subtext;if(shape){latLngs=this._shape.getLatLngs();area=L.GeometryUtil.geodesicArea(latLngs);subtext=L.GeometryUtil.readableArea(area,this.options.metric)}return{text:tooltipText.text,subtext:subtext}}});L.Draw.Circle=L.Draw.SimpleShape.extend({statics:{TYPE:"circle"},options:{shapeOptions:{stroke:true,color:"#f06eaa",weight:4,opacity:.5,fill:true,fillColor:null,fillOpacity:.2,clickable:true},showRadius:true,metric:true},initialize:function(map,options){this.type=L.Draw.Circle.TYPE;this._initialLabelText=L.drawLocal.draw.handlers.circle.tooltip.start;L.Draw.SimpleShape.prototype.initialize.call(this,map,options)},_drawShape:function(latlng){if(!this._shape){this._shape=new L.Circle(this._startLatLng,this._startLatLng.distanceTo(latlng),this.options.shapeOptions);this._map.addLayer(this._shape)}else{this._shape.setRadius(this._startLatLng.distanceTo(latlng))}},_fireCreatedEvent:function(){var circle=new L.Circle(this._startLatLng,this._shape.getRadius(),this.options.shapeOptions);L.Draw.SimpleShape.prototype._fireCreatedEvent.call(this,circle)},_onMouseMove:function(e){var latlng=e.latlng,showRadius=this.options.showRadius,useMetric=this.options.metric,radius;this._tooltip.updatePosition(latlng);if(this._isDrawing){this._drawShape(latlng);radius=this._shape.getRadius().toFixed(1);this._tooltip.updateContent({text:this._endLabelText,subtext:showRadius?L.drawLocal.draw.handlers.circle.radius+": "+L.GeometryUtil.readableDistance(radius,useMetric):""})}}});L.Draw.Marker=L.Draw.Feature.extend({statics:{TYPE:"marker"},options:{icon:new L.Icon.Default,repeatMode:false,zIndexOffset:2e3},initialize:function(map,options){this.type=L.Draw.Marker.TYPE;L.Draw.Feature.prototype.initialize.call(this,map,options)},addHooks:function(){L.Draw.Feature.prototype.addHooks.call(this);if(this._map){this._tooltip.updateContent({text:L.drawLocal.draw.handlers.marker.tooltip.start});if(!this._mouseMarker){this._mouseMarker=L.marker(this._map.getCenter(),{icon:L.divIcon({className:"leaflet-mouse-marker",iconAnchor:[20,20],iconSize:[40,40]}),opacity:0,zIndexOffset:this.options.zIndexOffset})}this._mouseMarker.on("click",this._onClick,this).addTo(this._map);this._map.on("mousemove",this._onMouseMove,this);this._map.on("click",this._onTouch,this)}},removeHooks:function(){L.Draw.Feature.prototype.removeHooks.call(this);if(this._map){if(this._marker){this._marker.off("click",this._onClick,this);this._map.off("click",this._onClick,this).off("click",this._onTouch,this).removeLayer(this._marker);delete this._marker}this._mouseMarker.off("click",this._onClick,this);this._map.removeLayer(this._mouseMarker);delete this._mouseMarker;this._map.off("mousemove",this._onMouseMove,this);this._map.off("click",this._onTouch,this)}},_onMouseMove:function(e){var latlng=e.latlng;this._tooltip.updatePosition(latlng);this._mouseMarker.setLatLng(latlng);if(!this._marker){this._marker=new L.Marker(latlng,{icon:this.options.icon,zIndexOffset:this.options.zIndexOffset});this._marker.on("click",this._onClick,this);this._map.on("click",this._onClick,this).addLayer(this._marker)}else{latlng=this._mouseMarker.getLatLng();this._marker.setLatLng(latlng)}},_onClick:function(){this._fireCreatedEvent();this.disable();if(this.options.repeatMode){this.enable()}},_onTouch:function(e){this._onMouseMove(e);this._onClick()},_fireCreatedEvent:function(){var marker=new L.Marker.Touch(this._marker.getLatLng(),{icon:this.options.icon});L.Draw.Feature.prototype._fireCreatedEvent.call(this,marker)}});L.Edit=L.Edit||{};L.Edit.Marker=L.Handler.extend({initialize:function(marker,options){this._marker=marker;L.setOptions(this,options)},addHooks:function(){var marker=this._marker;marker.dragging.enable();marker.on("dragend",this._onDragEnd,marker);this._toggleMarkerHighlight()},removeHooks:function(){var marker=this._marker;marker.dragging.disable();marker.off("dragend",this._onDragEnd,marker);this._toggleMarkerHighlight()},_onDragEnd:function(e){var layer=e.target;layer.edited=true},_toggleMarkerHighlight:function(){if(!this._icon){return}var icon=this._icon;icon.style.display="none";if(L.DomUtil.hasClass(icon,"leaflet-edit-marker-selected")){L.DomUtil.removeClass(icon,"leaflet-edit-marker-selected");this._offsetMarker(icon,-4)}else{L.DomUtil.addClass(icon,"leaflet-edit-marker-selected");this._offsetMarker(icon,4)}icon.style.display=""},_offsetMarker:function(icon,offset){var iconMarginTop=parseInt(icon.style.marginTop,10)-offset,iconMarginLeft=parseInt(icon.style.marginLeft,10)-offset;icon.style.marginTop=iconMarginTop+"px";icon.style.marginLeft=iconMarginLeft+"px"}});L.Marker.addInitHook(function(){if(L.Edit.Marker){this.editing=new L.Edit.Marker(this);if(this.options.editable){this.editing.enable()}}});L.Edit=L.Edit||{};L.Edit.Poly=L.Handler.extend({options:{icon:new L.DivIcon({iconSize:new L.Point(8,8),className:"leaflet-div-icon leaflet-editing-icon"}),touchIcon:new L.DivIcon({iconSize:new L.Point(20,20),className:"leaflet-div-icon leaflet-editing-icon leaflet-touch-icon"})},initialize:function(poly,options){if(L.Browser.touch){this.options.icon=this.options.touchIcon}this._poly=poly;L.setOptions(this,options)},addHooks:function(){var poly=this._poly;if(!(poly instanceof L.Polygon)){poly.options.editing.fill=false}poly.setStyle(poly.options.editing);if(this._poly._map){this._map=this._poly._map;if(!this._markerGroup){this._initMarkers()}this._poly._map.addLayer(this._markerGroup)}},removeHooks:function(){var poly=this._poly;poly.setStyle(poly.options.original);if(poly._map){poly._map.removeLayer(this._markerGroup);delete this._markerGroup;delete this._markers}},updateMarkers:function(){this._markerGroup.clearLayers();this._initMarkers()},_initMarkers:function(){if(!this._markerGroup){this._markerGroup=new L.LayerGroup}this._markers=[];var latlngs=this._poly._latlngs,i,j,len,marker;for(i=0,len=latlngs.length;i<len;i++){marker=this._createMarker(latlngs[i],i);marker.on("click",this._onMarkerClick,this);this._markers.push(marker)}var markerLeft,markerRight;for(i=0,j=len-1;i<len;j=i++){if(i===0&&!(L.Polygon&&this._poly instanceof L.Polygon)){continue}markerLeft=this._markers[j];markerRight=this._markers[i];this._createMiddleMarker(markerLeft,markerRight);this._updatePrevNext(markerLeft,markerRight)}},_createMarker:function(latlng,index){var marker=new L.Marker.Touch(latlng,{draggable:true,icon:this.options.icon});marker._origLatLng=latlng;marker._index=index;marker.on("drag",this._onMarkerDrag,this).on("dragend",this._fireEdit,this).on("touchmove",this._onTouchMove,this).on("touchend",this._fireEdit,this);this._markerGroup.addLayer(marker);return marker},_removeMarker:function(marker){var i=marker._index;this._markerGroup.removeLayer(marker);this._markers.splice(i,1);this._poly.spliceLatLngs(i,1);this._updateIndexes(i,-1);marker.off("drag",this._onMarkerDrag,this).off("dragend",this._fireEdit,this).off("touchmove",this._onMarkerDrag,this).off("touchend",this._fireEdit,this).off("click",this._onMarkerClick,this)},_fireEdit:function(){this._poly.edited=true;this._poly.fire("edit")},_onMarkerDrag:function(e){var marker=e.target;L.extend(marker._origLatLng,marker._latlng);if(marker._middleLeft){marker._middleLeft.setLatLng(this._getMiddleLatLng(marker._prev,marker))}if(marker._middleRight){marker._middleRight.setLatLng(this._getMiddleLatLng(marker,marker._next))}this._poly.redraw()},_onMarkerClick:function(e){var minPoints=L.Polygon&&this._poly instanceof L.Polygon?4:3,marker=e.target;if(this._poly._latlngs.length<minPoints){return}this._removeMarker(marker);this._updatePrevNext(marker._prev,marker._next);if(marker._middleLeft){this._markerGroup.removeLayer(marker._middleLeft)}if(marker._middleRight){this._markerGroup.removeLayer(marker._middleRight)}if(marker._prev&&marker._next){this._createMiddleMarker(marker._prev,marker._next)}else if(!marker._prev){marker._next._middleLeft=null}else if(!marker._next){marker._prev._middleRight=null}this._fireEdit()},_onTouchMove:function(e){var layerPoint=this._map.mouseEventToLayerPoint(e.originalEvent.touches[0]),latlng=this._map.layerPointToLatLng(layerPoint),marker=e.target;L.extend(marker._origLatLng,latlng);if(marker._middleLeft){marker._middleLeft.setLatLng(this._getMiddleLatLng(marker._prev,marker))}if(marker._middleRight){marker._middleRight.setLatLng(this._getMiddleLatLng(marker,marker._next))}this._poly.redraw();this.updateMarkers()},_updateIndexes:function(index,delta){this._markerGroup.eachLayer(function(marker){if(marker._index>index){marker._index+=delta}})},_createMiddleMarker:function(marker1,marker2){var latlng=this._getMiddleLatLng(marker1,marker2),marker=this._createMarker(latlng),onClick,onDragStart,onDragEnd;marker.setOpacity(.6);marker1._middleRight=marker2._middleLeft=marker
;onDragStart=function(){var i=marker2._index;marker._index=i;marker.off("click",onClick,this).on("click",this._onMarkerClick,this);latlng.lat=marker.getLatLng().lat;latlng.lng=marker.getLatLng().lng;this._poly.spliceLatLngs(i,0,latlng);this._markers.splice(i,0,marker);marker.setOpacity(1);this._updateIndexes(i,1);marker2._index++;this._updatePrevNext(marker1,marker);this._updatePrevNext(marker,marker2);this._poly.fire("editstart")};onDragEnd=function(){marker.off("dragstart",onDragStart,this);marker.off("dragend",onDragEnd,this);marker.off("touchmove",onDragStart,this);this._createMiddleMarker(marker1,marker);this._createMiddleMarker(marker,marker2)};onClick=function(){onDragStart.call(this);onDragEnd.call(this);this._fireEdit()};marker.on("click",onClick,this).on("dragstart",onDragStart,this).on("dragend",onDragEnd,this).on("touchmove",onDragStart,this);this._markerGroup.addLayer(marker)},_updatePrevNext:function(marker1,marker2){if(marker1){marker1._next=marker2}if(marker2){marker2._prev=marker1}},_getMiddleLatLng:function(marker1,marker2){var map=this._poly._map,p1=map.project(marker1.getLatLng()),p2=map.project(marker2.getLatLng());return map.unproject(p1._add(p2)._divideBy(2))}});L.Polyline.addInitHook(function(){if(this.editing){return}if(L.Edit.Poly){this.editing=new L.Edit.Poly(this);if(this.options.editable){this.editing.enable()}}this.on("add",function(){if(this.editing&&this.editing.enabled()){this.editing.addHooks()}});this.on("remove",function(){if(this.editing&&this.editing.enabled()){this.editing.removeHooks()}})});L.Edit=L.Edit||{};L.Edit.SimpleShape=L.Handler.extend({options:{moveIcon:new L.DivIcon({iconSize:new L.Point(8,8),className:"leaflet-div-icon leaflet-editing-icon leaflet-edit-move"}),resizeIcon:new L.DivIcon({iconSize:new L.Point(8,8),className:"leaflet-div-icon leaflet-editing-icon leaflet-edit-resize"}),touchMoveIcon:new L.DivIcon({iconSize:new L.Point(20,20),className:"leaflet-div-icon leaflet-editing-icon leaflet-edit-move leaflet-touch-icon"}),touchResizeIcon:new L.DivIcon({iconSize:new L.Point(20,20),className:"leaflet-div-icon leaflet-editing-icon leaflet-edit-resize leaflet-touch-icon"})},initialize:function(shape,options){if(L.Browser.touch){this.options.moveIcon=this.options.touchMoveIcon;this.options.resizeIcon=this.options.touchResizeIcon}this._shape=shape;L.Util.setOptions(this,options)},addHooks:function(){var shape=this._shape;if(this._shape._map){this._map=this._shape._map;shape.setStyle(shape.options.editing);if(shape._map){this._map=shape._map;if(!this._markerGroup){this._initMarkers()}this._map.addLayer(this._markerGroup)}}},removeHooks:function(){var shape=this._shape;shape.setStyle(shape.options.original);if(shape._map){this._unbindMarker(this._moveMarker);for(var i=0,l=this._resizeMarkers.length;i<l;i++){this._unbindMarker(this._resizeMarkers[i])}this._resizeMarkers=null;this._map.removeLayer(this._markerGroup);delete this._markerGroup}this._map=null},updateMarkers:function(){this._markerGroup.clearLayers();this._initMarkers()},_initMarkers:function(){if(!this._markerGroup){this._markerGroup=new L.LayerGroup}this._createMoveMarker();this._createResizeMarker()},_createMoveMarker:function(){},_createResizeMarker:function(){},_createMarker:function(latlng,icon){var marker=new L.Marker.Touch(latlng,{draggable:true,icon:icon,zIndexOffset:10});this._bindMarker(marker);this._markerGroup.addLayer(marker);return marker},_bindMarker:function(marker){marker.on("dragstart",this._onMarkerDragStart,this).on("drag",this._onMarkerDrag,this).on("dragend",this._onMarkerDragEnd,this).on("touchstart",this._onTouchStart,this).on("touchmove",this._onTouchMove,this).on("touchend",this._onTouchEnd,this)},_unbindMarker:function(marker){marker.off("dragstart",this._onMarkerDragStart,this).off("drag",this._onMarkerDrag,this).off("dragend",this._onMarkerDragEnd,this).off("touchstart",this._onTouchStart,this).off("touchmove",this._onTouchMove,this).off("touchend",this._onTouchEnd,this)},_onMarkerDragStart:function(e){var marker=e.target;marker.setOpacity(0);this._shape.fire("editstart")},_fireEdit:function(){this._shape.edited=true;this._shape.fire("edit")},_onMarkerDrag:function(e){var marker=e.target,latlng=marker.getLatLng();if(marker===this._moveMarker){this._move(latlng)}else{this._resize(latlng)}this._shape.redraw()},_onMarkerDragEnd:function(e){var marker=e.target;marker.setOpacity(1);this._fireEdit()},_onTouchStart:function(e){L.Edit.SimpleShape.prototype._onMarkerDragStart.call(this,e);if(typeof this._getCorners==="function"){var corners=this._getCorners(),marker=e.target,currentCornerIndex=marker._cornerIndex;marker.setOpacity(0);this._oppositeCorner=corners[(currentCornerIndex+2)%4];this._toggleCornerMarkers(0,currentCornerIndex)}this._shape.fire("editstart")},_onTouchMove:function(e){var layerPoint=this._map.mouseEventToLayerPoint(e.originalEvent.touches[0]),latlng=this._map.layerPointToLatLng(layerPoint),marker=e.target;if(marker===this._moveMarker){this._move(latlng)}else{this._resize(latlng)}this._shape.redraw();if(marker===this._moveMarker){this._moveMarker.setLatLng(this._shape.getLatLng())}else{this.updateMarkers()}return false},_onTouchEnd:function(e){var marker=e.target;marker.setOpacity(1);this.updateMarkers();this._fireEdit()},_move:function(){},_resize:function(){}});L.Edit=L.Edit||{};L.Edit.Rectangle=L.Edit.SimpleShape.extend({_createMoveMarker:function(){var bounds=this._shape.getBounds(),center=bounds.getCenter();this._moveMarker=this._createMarker(center,this.options.moveIcon)},_createResizeMarker:function(){var corners=this._getCorners();this._resizeMarkers=[];for(var i=0,l=corners.length;i<l;i++){this._resizeMarkers.push(this._createMarker(corners[i],this.options.resizeIcon));this._resizeMarkers[i]._cornerIndex=i}},_onMarkerDragStart:function(e){L.Edit.SimpleShape.prototype._onMarkerDragStart.call(this,e);var corners=this._getCorners(),marker=e.target,currentCornerIndex=marker._cornerIndex;this._oppositeCorner=corners[(currentCornerIndex+2)%4];this._toggleCornerMarkers(0,currentCornerIndex)},_onMarkerDragEnd:function(e){var marker=e.target,bounds,center;if(marker===this._moveMarker){bounds=this._shape.getBounds();center=bounds.getCenter();marker.setLatLng(center)}this._toggleCornerMarkers(1);this._repositionCornerMarkers();L.Edit.SimpleShape.prototype._onMarkerDragEnd.call(this,e)},_move:function(newCenter){var latlngs=this._shape.getLatLngs(),bounds=this._shape.getBounds(),center=bounds.getCenter(),offset,newLatLngs=[];for(var i=0,l=latlngs.length;i<l;i++){offset=[latlngs[i].lat-center.lat,latlngs[i].lng-center.lng];newLatLngs.push([newCenter.lat+offset[0],newCenter.lng+offset[1]])}this._shape.setLatLngs(newLatLngs);this._repositionCornerMarkers()},_resize:function(latlng){var bounds;if(this._shape.options.aspectRatio!==undefined){bounds=this._shape.getBounds();var opposite=this._map.project(this._oppositeCorner).round(),dragPoint=this._map.project(latlng).round(),ydiff=Math.abs(opposite.y-dragPoint.y)*this._shape.options.aspectRatio;if(opposite.x<dragPoint.x){dragPoint.x=opposite.x+ydiff}else{dragPoint.x=opposite.x-ydiff}latlng=this._map.unproject(dragPoint)}this._shape.setBounds(L.latLngBounds(latlng,this._oppositeCorner));bounds=this._shape.getBounds();this._moveMarker.setLatLng(bounds.getCenter())},_getCorners:function(){var bounds=this._shape.getBounds(),nw=bounds.getNorthWest(),ne=bounds.getNorthEast(),se=bounds.getSouthEast(),sw=bounds.getSouthWest();return[nw,ne,se,sw]},_toggleCornerMarkers:function(opacity){for(var i=0,l=this._resizeMarkers.length;i<l;i++){this._resizeMarkers[i].setOpacity(opacity)}},_repositionCornerMarkers:function(){var corners=this._getCorners();for(var i=0,l=this._resizeMarkers.length;i<l;i++){this._resizeMarkers[i].setLatLng(corners[i])}}});L.Rectangle.addInitHook(function(){if(L.Edit.Rectangle){this.editing=new L.Edit.Rectangle(this);if(this.options.editable){this.editing.enable()}}});L.Edit=L.Edit||{};L.Edit.Circle=L.Edit.SimpleShape.extend({_createMoveMarker:function(){var center=this._shape.getLatLng();this._moveMarker=this._createMarker(center,this.options.moveIcon)},_createResizeMarker:function(){var center=this._shape.getLatLng(),resizemarkerPoint=this._getResizeMarkerPoint(center);this._resizeMarkers=[];this._resizeMarkers.push(this._createMarker(resizemarkerPoint,this.options.resizeIcon))},_getResizeMarkerPoint:function(latlng){var delta=this._shape._radius*Math.cos(Math.PI/4),point=this._map.project(latlng);return this._map.unproject([point.x+delta,point.y-delta])},_move:function(latlng){var resizemarkerPoint=this._getResizeMarkerPoint(latlng);this._resizeMarkers[0].setLatLng(resizemarkerPoint);this._shape.setLatLng(latlng)},_resize:function(latlng){var moveLatLng=this._moveMarker.getLatLng(),radius=moveLatLng.distanceTo(latlng);this._shape.setRadius(radius)}});L.Circle.addInitHook(function(){if(L.Edit.Circle){this.editing=new L.Edit.Circle(this);if(this.options.editable){this.editing.enable()}}this.on("add",function(){if(this.editing&&this.editing.enabled()){this.editing.addHooks()}});this.on("remove",function(){if(this.editing&&this.editing.enabled()){this.editing.removeHooks()}})});L.Map.mergeOptions({touchExtend:true});L.Map.TouchExtend=L.Handler.extend({initialize:function(map){this._map=map;this._container=map._container;this._pane=map._panes.overlayPane},addHooks:function(){L.DomEvent.on(this._container,"touchstart",this._onTouchStart,this);L.DomEvent.on(this._container,"touchend",this._onTouchEnd,this);L.DomEvent.on(this._container,"touchcancel",this._onTouchCancel,this);L.DomEvent.on(this._container,"touchleave",this._onTouchLeave,this);L.DomEvent.on(this._container,"touchmove",this._onTouchMove,this)},removeHooks:function(){L.DomEvent.off(this._container,"touchstart",this._onTouchStart);L.DomEvent.off(this._container,"touchend",this._onTouchEnd);L.DomEvent.off(this._container,"touchcancel",this._onTouchCancel);L.DomEvent.off(this._container,"touchleave",this._onTouchLeave);L.DomEvent.off(this._container,"touchmove",this._onTouchMove)},_touchEvent:function(e,type){if(!e.touches.length){return}var containerPoint=this._map.mouseEventToContainerPoint(e.touches[0]),layerPoint=this._map.mouseEventToLayerPoint(e.touches[0]),latlng=this._map.layerPointToLatLng(layerPoint);this._map.fire(type,{latlng:latlng,layerPoint:layerPoint,containerPoint:containerPoint,pageX:e.touches[0].pageX,pageY:e.touches[0].pageY,originalEvent:e})},_onTouchStart:function(e){if(!this._map._loaded){return}var type="touchstart";this._touchEvent(e,type)},_onTouchEnd:function(e){if(!this._map._loaded){return}var type="touchend";this._touchEvent(e,type)},_onTouchCancel:function(e){if(!this._map._loaded){return}var type="touchcancel";this._touchEvent(e,type)},_onTouchLeave:function(e){if(!this._map._loaded){return}var type="touchleave";this._touchEvent(e,type)},_onTouchMove:function(e){if(!this._map._loaded){return}var type="touchmove";this._touchEvent(e,type)}});L.Map.addInitHook("addHandler","touchExtend",L.Map.TouchExtend);L.Marker.Touch=L.Marker.extend({_initInteraction:function(){if(!this.options.clickable){return}var icon=this._icon,events=["dblclick","mousedown","mouseover","mouseout","contextmenu","touchstart","touchend","touchmove","touchcancel"];L.DomUtil.addClass(icon,"leaflet-clickable");L.DomEvent.on(icon,"click",this._onMouseClick,this);L.DomEvent.on(icon,"keypress",this._onKeyPress,this);for(var i=0;i<events.length;i++){L.DomEvent.on(icon,events[i],this._fireMouseEvent,this)}if(L.Handler.MarkerDrag){this.dragging=new L.Handler.MarkerDrag(this);if(this.options.draggable){this.dragging.enable()}}}});L.LatLngUtil={cloneLatLngs:function(latlngs){var clone=[];for(var i=0,l=latlngs.length;i<l;i++){clone.push(this.cloneLatLng(latlngs[i]))}return clone},cloneLatLng:function(latlng){return L.latLng(latlng.lat,latlng.lng)}};L.GeometryUtil=L.extend(L.GeometryUtil||{},{geodesicArea:function(latLngs){var pointsCount=latLngs.length,area=0,d2r=L.LatLng.DEG_TO_RAD,p1,p2;if(pointsCount>2){for(var i=0;i<pointsCount;i++){p1=latLngs[i];p2=latLngs[(i+1)%pointsCount];area+=(p2.lng-p1.lng)*d2r*(2+Math.sin(p1.lat*d2r)+Math.sin(p2.lat*d2r))}area=area*6378137*6378137/2}return Math.abs(area)},readableArea:function(area,isMetric){var areaStr;if(isMetric){if(area>=1e4){areaStr=(area*1e-4).toFixed(2)+" ha"}else{areaStr=area.toFixed(2)+" m&sup2;"}}else{area/=.836127;if(area>=3097600){areaStr=(area/3097600).toFixed(2)+" mi&sup2;"}else if(area>=4840){areaStr=(area/4840).toFixed(2)+" acres"}else{areaStr=Math.ceil(area)+" yd&sup2;"}}return areaStr},readableDistance:function(distance,isMetric){var distanceStr;if(isMetric){if(distance>1e3){distanceStr=(distance/1e3).toFixed(2)+" km"}else{distanceStr=Math.ceil(distance)+" m"}}else{distance*=1.09361;if(distance>1760){distanceStr=(distance/1760).toFixed(2)+" miles"}else{distanceStr=Math.ceil(distance)+" yd"}}return distanceStr}});L.Util.extend(L.LineUtil,{segmentsIntersect:function(p,p1,p2,p3){return this._checkCounterclockwise(p,p2,p3)!==this._checkCounterclockwise(p1,p2,p3)&&this._checkCounterclockwise(p,p1,p2)!==this._checkCounterclockwise(p,p1,p3)},_checkCounterclockwise:function(p,p1,p2){return(p2.y-p.y)*(p1.x-p.x)>(p1.y-p.y)*(p2.x-p.x)}});L.Polyline.include({intersects:function(){var points=this._originalPoints,len=points?points.length:0,i,p,p1;if(this._tooFewPointsForIntersection()){return false}for(i=len-1;i>=3;i--){p=points[i-1];p1=points[i];if(this._lineSegmentsIntersectsRange(p,p1,i-2)){return true}}return false},newLatLngIntersects:function(latlng,skipFirst){if(!this._map){return false}return this.newPointIntersects(this._map.latLngToLayerPoint(latlng),skipFirst)},newPointIntersects:function(newPoint,skipFirst){var points=this._originalPoints,len=points?points.length:0,lastPoint=points?points[len-1]:null,maxIndex=len-2;if(this._tooFewPointsForIntersection(1)){return false}return this._lineSegmentsIntersectsRange(lastPoint,newPoint,maxIndex,skipFirst?1:0)},_tooFewPointsForIntersection:function(extraPoints){var points=this._originalPoints,len=points?points.length:0;len+=extraPoints||0;return!this._originalPoints||len<=3},_lineSegmentsIntersectsRange:function(p,p1,maxIndex,minIndex){var points=this._originalPoints,p2,p3;minIndex=minIndex||0;for(var j=maxIndex;j>minIndex;j--){p2=points[j-1];p3=points[j];if(L.LineUtil.segmentsIntersect(p,p1,p2,p3)){return true}}return false}});L.Polygon.include({intersects:function(){var polylineIntersects,points=this._originalPoints,len,firstPoint,lastPoint,maxIndex;if(this._tooFewPointsForIntersection()){return false}polylineIntersects=L.Polyline.prototype.intersects.call(this);if(polylineIntersects){return true}len=points.length;firstPoint=points[0];lastPoint=points[len-1];maxIndex=len-2;return this._lineSegmentsIntersectsRange(lastPoint,firstPoint,maxIndex,1)}});L.Control.Draw=L.Control.extend({options:{position:"topleft",draw:{},edit:false},initialize:function(options){if(L.version<"0.7"){throw new Error("Leaflet.draw 0.2.3+ requires Leaflet 0.7.0+. Download latest from https://github.com/Leaflet/Leaflet/")}L.Control.prototype.initialize.call(this,options);var toolbar;this._toolbars={};if(L.DrawToolbar&&this.options.draw){toolbar=new L.DrawToolbar(this.options.draw);this._toolbars[L.DrawToolbar.TYPE]=toolbar;this._toolbars[L.DrawToolbar.TYPE].on("enable",this._toolbarEnabled,this)}if(L.EditToolbar&&this.options.edit){toolbar=new L.EditToolbar(this.options.edit);this._toolbars[L.EditToolbar.TYPE]=toolbar;this._toolbars[L.EditToolbar.TYPE].on("enable",this._toolbarEnabled,this)}L.toolbar=this},onAdd:function(map){var container=L.DomUtil.create("div","leaflet-draw"),addedTopClass=false,topClassName="leaflet-draw-toolbar-top",toolbarContainer;for(var toolbarId in this._toolbars){if(this._toolbars.hasOwnProperty(toolbarId)){toolbarContainer=this._toolbars[toolbarId].addToolbar(map);if(toolbarContainer){if(!addedTopClass){if(!L.DomUtil.hasClass(toolbarContainer,topClassName)){L.DomUtil.addClass(toolbarContainer.childNodes[0],topClassName)}addedTopClass=true}container.appendChild(toolbarContainer)}}}return container},onRemove:function(){for(var toolbarId in this._toolbars){if(this._toolbars.hasOwnProperty(toolbarId)){this._toolbars[toolbarId].removeToolbar()}}},setDrawingOptions:function(options){for(var toolbarId in this._toolbars){if(this._toolbars[toolbarId]instanceof L.DrawToolbar){this._toolbars[toolbarId].setOptions(options)}}},_toolbarEnabled:function(e){var enabledToolbar=e.target;for(var toolbarId in this._toolbars){if(this._toolbars[toolbarId]!==enabledToolbar){this._toolbars[toolbarId].disable()}}}});L.Map.mergeOptions({drawControlTooltips:true,drawControl:false});L.Map.addInitHook(function(){if(this.options.drawControl){this.drawControl=new L.Control.Draw;this.addControl(this.drawControl)}});L.Toolbar=L.Class.extend({includes:[L.Mixin.Events],initialize:function(options){L.setOptions(this,options);this._modes={};this._actionButtons=[];this._activeMode=null},enabled:function(){return this._activeMode!==null},disable:function(){if(!this.enabled()){return}this._activeMode.handler.disable()},addToolbar:function(map){var container=L.DomUtil.create("div","leaflet-draw-section"),buttonIndex=0,buttonClassPrefix=this._toolbarClass||"",modeHandlers=this.getModeHandlers(map),i;this._toolbarContainer=L.DomUtil.create("div","leaflet-draw-toolbar leaflet-bar");this._map=map;for(i=0;i<modeHandlers.length;i++){if(modeHandlers[i].enabled){this._initModeHandler(modeHandlers[i].handler,this._toolbarContainer,buttonIndex++,buttonClassPrefix,modeHandlers[i].title)}}if(!buttonIndex){return}this._lastButtonIndex=--buttonIndex;this._actionsContainer=L.DomUtil.create("ul","leaflet-draw-actions");container.appendChild(this._toolbarContainer);container.appendChild(this._actionsContainer);return container},removeToolbar:function(){for(var handlerId in this._modes){if(this._modes.hasOwnProperty(handlerId)){this._disposeButton(this._modes[handlerId].button,this._modes[handlerId].handler.enable,this._modes[handlerId].handler);this._modes[handlerId].handler.disable();this._modes[handlerId].handler.off("enabled",this._handlerActivated,this).off("disabled",this._handlerDeactivated,this)}}this._modes={};for(var i=0,l=this._actionButtons.length;i<l;i++){this._disposeButton(this._actionButtons[i].button,this._actionButtons[i].callback,this)}this._actionButtons=[];this._actionsContainer=null},_initModeHandler:function(handler,container,buttonIndex,classNamePredix,buttonTitle){var type=handler.type;this._modes[type]={};this._modes[type].handler=handler;this._modes[type].button=this._createButton({type:type,title:buttonTitle,className:classNamePredix+"-"+type,container:container,callback:this._modes[type].handler.enable,context:this._modes[type].handler});this._modes[type].buttonIndex=buttonIndex;this._modes[type].handler.on("enabled",this._handlerActivated,this).on("disabled",this._handlerDeactivated,this)},_createButton:function(options){var link=L.DomUtil.create("a",options.className||"",options.container);link.href="#";if(options.text){link.innerHTML=options.text}if(options.title){link.title=options.title}L.DomEvent.on(link,"click",L.DomEvent.stopPropagation).on(link,"mousedown",L.DomEvent.stopPropagation).on(link,"dblclick",L.DomEvent.stopPropagation).on(link,"click",L.DomEvent.preventDefault).on(link,"click",options.callback,options.context);return link},_disposeButton:function(button,callback){L.DomEvent.off(button,"click",L.DomEvent.stopPropagation).off(button,"mousedown",L.DomEvent.stopPropagation).off(button,"dblclick",L.DomEvent.stopPropagation).off(button,"click",L.DomEvent.preventDefault).off(button,"click",callback)},_handlerActivated:function(e){this.disable();this._activeMode=this._modes[e.handler];L.DomUtil.addClass(this._activeMode.button,"leaflet-draw-toolbar-button-enabled");this._showActionsToolbar();this.fire("enable")},_handlerDeactivated:function(){this._hideActionsToolbar();L.DomUtil.removeClass(this._activeMode.button,"leaflet-draw-toolbar-button-enabled");this._activeMode=null;this.fire("disable")},_createActions:function(handler){var container=this._actionsContainer,buttons=this.getActions(handler),l=buttons.length,li,di,dl,button;for(di=0,dl=this._actionButtons.length;di<dl;di++){this._disposeButton(this._actionButtons[di].button,this._actionButtons[di].callback)}this._actionButtons=[];while(container.firstChild){container.removeChild(container.firstChild)}for(var i=0;i<l;i++){if("enabled"in buttons[i]&&!buttons[i].enabled){continue}li=L.DomUtil.create("li","",container);button=this._createButton({title:buttons[i].title,text:buttons[i].text,container:li,callback:buttons[i].callback,context:buttons[i].context});this._actionButtons.push({button:button,callback:buttons[i].callback})}},_showActionsToolbar:function(){var buttonIndex=this._activeMode.buttonIndex,lastButtonIndex=this._lastButtonIndex,toolbarPosition=this._activeMode.button.offsetTop-1;this._createActions(this._activeMode.handler);this._actionsContainer.style.top=toolbarPosition+"px";if(buttonIndex===0){L.DomUtil.addClass(this._toolbarContainer,"leaflet-draw-toolbar-notop");L.DomUtil.addClass(this._actionsContainer,"leaflet-draw-actions-top")}if(buttonIndex===lastButtonIndex){L.DomUtil.addClass(this._toolbarContainer,"leaflet-draw-toolbar-nobottom");L.DomUtil.addClass(this._actionsContainer,"leaflet-draw-actions-bottom")}this._actionsContainer.style.display="block"},_hideActionsToolbar:function(){this._actionsContainer.style.display="none";L.DomUtil.removeClass(this._toolbarContainer,"leaflet-draw-toolbar-notop");L.DomUtil.removeClass(this._toolbarContainer,"leaflet-draw-toolbar-nobottom");L.DomUtil.removeClass(this._actionsContainer,"leaflet-draw-actions-top");L.DomUtil.removeClass(this._actionsContainer,"leaflet-draw-actions-bottom")}});L.Tooltip=L.Class.extend({initialize:function(map){this._map=map;this._popupPane=map._panes.popupPane;this._container=map.options.drawControlTooltips?L.DomUtil.create("div","leaflet-draw-tooltip",this._popupPane):null;this._singleLineLabel=false},dispose:function(){if(this._container){this._popupPane.removeChild(this._container);this._container=null}},updateContent:function(labelText){if(!this._container){return this}labelText.subtext=labelText.subtext||"";if(labelText.subtext.length===0&&!this._singleLineLabel){L.DomUtil.addClass(this._container,"leaflet-draw-tooltip-single");this._singleLineLabel=true}else if(labelText.subtext.length>0&&this._singleLineLabel){L.DomUtil.removeClass(this._container,"leaflet-draw-tooltip-single");this._singleLineLabel=false}this._container.innerHTML=(labelText.subtext.length>0?'<span class="leaflet-draw-tooltip-subtext">'+labelText.subtext+"</span>"+"<br />":"")+"<span>"+labelText.text+"</span>";return this},updatePosition:function(latlng){var pos=this._map.latLngToLayerPoint(latlng),tooltipContainer=this._container;if(this._container){tooltipContainer.style.visibility="inherit";L.DomUtil.setPosition(tooltipContainer,pos)}return this},showAsError:function(){if(this._container){L.DomUtil.addClass(this._container,"leaflet-error-draw-tooltip")}return this},removeError:function(){if(this._container){L.DomUtil.removeClass(this._container,"leaflet-error-draw-tooltip")}return this}});L.DrawToolbar=L.Toolbar.extend({statics:{TYPE:"draw"},options:{polyline:{},polygon:{},rectangle:{},circle:{},marker:{}},initialize:function(options){for(var type in this.options){if(this.options.hasOwnProperty(type)){if(options[type]){options[type]=L.extend({},this.options[type],options[type])}}}this._toolbarClass="leaflet-draw-draw";L.Toolbar.prototype.initialize.call(this,options)},getModeHandlers:function(map){return[{enabled:this.options.polyline,handler:new L.Draw.Polyline(map,this.options.polyline),title:L.drawLocal.draw.toolbar.buttons.polyline},{enabled:this.options.polygon,handler:new L.Draw.Polygon(map,this.options.polygon),title:L.drawLocal.draw.toolbar.buttons.polygon},{enabled:this.options.rectangle,handler:new L.Draw.Rectangle(map,this.options.rectangle),title:L.drawLocal.draw.toolbar.buttons.rectangle},{enabled:this.options.circle,handler:new L.Draw.Circle(map,this.options.circle),title:L.drawLocal.draw.toolbar.buttons.circle},{enabled:this.options.marker,handler:new L.Draw.Marker(map,this.options.marker),title:L.drawLocal.draw.toolbar.buttons.marker}]},getActions:function(handler){return[{enabled:handler.completeShape,title:L.drawLocal.draw.toolbar.finish.title,text:L.drawLocal.draw.toolbar.finish.text,callback:handler.completeShape,context:handler},{enabled:handler.deleteLastVertex,title:L.drawLocal.draw.toolbar.undo.title,text:L.drawLocal.draw.toolbar.undo.text,callback:handler.deleteLastVertex,context:handler},{title:L.drawLocal.draw.toolbar.actions.title,text:L.drawLocal.draw.toolbar.actions.text,callback:this.disable,context:this}]},setOptions:function(options){L.setOptions(this,options);for(var type in this._modes){if(this._modes.hasOwnProperty(type)&&options.hasOwnProperty(type)){this._modes[type].handler.setOptions(options[type])}}}});L.EditToolbar=L.Toolbar.extend({statics:{TYPE:"edit"},options:{edit:{selectedPathOptions:{dashArray:"10, 10",fill:true,fillColor:"#fe57a1",fillOpacity:.1,maintainColor:false}},remove:{},featureGroup:null},initialize:function(options){if(options.edit){if(typeof options.edit.selectedPathOptions==="undefined"){options.edit.selectedPathOptions=this.options.edit.selectedPathOptions}options.edit.selectedPathOptions=L.extend({},this.options.edit.selectedPathOptions,options.edit.selectedPathOptions)}if(options.remove){options.remove=L.extend({},this.options.remove,options.remove)}this._toolbarClass="leaflet-draw-edit";L.Toolbar.prototype.initialize.call(this,options);this._selectedFeatureCount=0},getModeHandlers:function(map){var featureGroup=this.options.featureGroup;return[{enabled:this.options.edit,handler:new L.EditToolbar.Edit(map,{featureGroup:featureGroup,selectedPathOptions:this.options.edit.selectedPathOptions}),title:L.drawLocal.edit.toolbar.buttons.edit},{enabled:this.options.remove,handler:new L.EditToolbar.Delete(map,{featureGroup:featureGroup}),title:L.drawLocal.edit.toolbar.buttons.remove}]},getActions:function(){return[{title:L.drawLocal.edit.toolbar.actions.save.title,text:L.drawLocal.edit.toolbar.actions.save.text,callback:this._save,context:this},{title:L.drawLocal.edit.toolbar.actions.cancel.title,text:L.drawLocal.edit.toolbar.actions.cancel.text,callback:this.disable,context:this}]},addToolbar:function(map){var container=L.Toolbar.prototype.addToolbar.call(this,map);this._checkDisabled();this.options.featureGroup.on("layeradd layerremove",this._checkDisabled,this);return container},removeToolbar:function(){this.options.featureGroup.off("layeradd layerremove",this._checkDisabled,this);L.Toolbar.prototype.removeToolbar.call(this)},disable:function(){if(!this.enabled()){return}this._activeMode.handler.revertLayers();L.Toolbar.prototype.disable.call(this)},_save:function(){this._activeMode.handler.save();this._activeMode.handler.disable()},_checkDisabled:function(){var featureGroup=this.options.featureGroup,hasLayers=featureGroup.getLayers().length!==0,button;if(this.options.edit){button=this._modes[L.EditToolbar.Edit.TYPE].button;if(hasLayers){L.DomUtil.removeClass(button,"leaflet-disabled")}else{L.DomUtil.addClass(button,"leaflet-disabled")}button.setAttribute("title",hasLayers?L.drawLocal.edit.toolbar.buttons.edit:L.drawLocal.edit.toolbar.buttons.editDisabled)}if(this.options.remove){button=this._modes[L.EditToolbar.Delete.TYPE].button;if(hasLayers){L.DomUtil.removeClass(button,"leaflet-disabled")}else{L.DomUtil.addClass(button,"leaflet-disabled")}button.setAttribute("title",hasLayers?L.drawLocal.edit.toolbar.buttons.remove:L.drawLocal.edit.toolbar.buttons.removeDisabled)}}});L.EditToolbar.Edit=L.Handler.extend({statics:{TYPE:"edit"},includes:L.Mixin.Events,initialize:function(map,options){L.Handler.prototype.initialize.call(this,map);L.setOptions(this,options);this._featureGroup=options.featureGroup;if(!(this._featureGroup instanceof L.FeatureGroup)){throw new Error("options.featureGroup must be a L.FeatureGroup")}this._uneditedLayerProps={};this.type=L.EditToolbar.Edit.TYPE},enable:function(){if(this._enabled||!this._hasAvailableLayers()){return}this.fire("enabled",{handler:this.type});this._map.fire("draw:editstart",{handler:this.type});L.Handler.prototype.enable.call(this);this._featureGroup.on("layeradd",this._enableLayerEdit,this).on("layerremove",this._disableLayerEdit,this)},disable:function(){if(!this._enabled){return}this._featureGroup.off("layeradd",this._enableLayerEdit,this).off("layerremove",this._disableLayerEdit,this);L.Handler.prototype.disable.call(this);this._map.fire("draw:editstop",{handler:this.type});this.fire("disabled",{handler:this.type})},addHooks:function(){var map=this._map;if(map){map.getContainer().focus();this._featureGroup.eachLayer(this._enableLayerEdit,this);this._tooltip=new L.Tooltip(this._map);this._tooltip.updateContent({text:L.drawLocal.edit.handlers.edit.tooltip.text,subtext:L.drawLocal.edit.handlers.edit.tooltip.subtext});this._map.on("mousemove",this._onMouseMove,this).on("touchmove",this._onMouseMove,this).on("click",this._editStyle,this)}},removeHooks:function(){if(this._map){this._featureGroup.eachLayer(this._disableLayerEdit,this);this._uneditedLayerProps={};this._tooltip.dispose();this._tooltip=null;this._map.off("mousemove",this._onMouseMove,this).off("touchmove",this._onMouseMove,this)}},revertLayers:function(){this._featureGroup.eachLayer(function(layer){this._revertLayer(layer)},this)},save:function(){var editedLayers=new L.LayerGroup;this._featureGroup.eachLayer(function(layer){if(layer.edited){editedLayers.addLayer(layer);layer.edited=false}});this._map.fire("draw:edited",{layers:editedLayers})},_backupLayer:function(layer){var id=L.Util.stamp(layer);if(!this._uneditedLayerProps[id]){if(layer instanceof L.Polyline||layer instanceof L.Polygon||layer instanceof L.Rectangle){this._uneditedLayerProps[id]={latlngs:L.LatLngUtil.cloneLatLngs(layer.getLatLngs())}}else if(layer instanceof L.Circle){this._uneditedLayerProps[id]={latlng:L.LatLngUtil.cloneLatLng(layer.getLatLng()),radius:layer.getRadius()}}else if(layer instanceof L.Marker){this._uneditedLayerProps[id]={latlng:L.LatLngUtil.cloneLatLng(layer.getLatLng())}}}},_revertLayer:function(layer){var id=L.Util.stamp(layer);layer.edited=false;if(this._uneditedLayerProps.hasOwnProperty(id)){if(layer instanceof L.Polyline||layer instanceof L.Polygon||layer instanceof L.Rectangle){layer.setLatLngs(this._uneditedLayerProps[id].latlngs)}else if(layer instanceof L.Circle){layer.setLatLng(this._uneditedLayerProps[id].latlng);layer.setRadius(this._uneditedLayerProps[id].radius)}else if(layer instanceof L.Marker){layer.setLatLng(this._uneditedLayerProps[id].latlng)}layer.fire("revert-edited",{layer:layer})}},_enableLayerEdit:function(e){var layer=e.layer||e.target||e,pathOptions;this._backupLayer(layer);if(this.options.selectedPathOptions){pathOptions=L.Util.extend({},this.options.selectedPathOptions);if(pathOptions.maintainColor){pathOptions.color=layer.options.color;pathOptions.fillColor=layer.options.fillColor}layer.options.original=L.extend({},layer.options);layer.options.editing=pathOptions}if(this.isMarker){layer.dragging.enable();layer.on("dragend",this._onMarkerDragEnd).on("touchmove",this._onTouchMove,this).on("touchend",this._onMarkerDragEnd,this)}else{layer.editing.enable()}},_disableLayerEdit:function(e){var layer=e.layer||e.target||e;layer.edited=false;layer.editing.disable();delete layer.options.editing;delete layer.options.original;if(this._selectedPathOptions){if(layer instanceof L.Marker){this._toggleMarkerHighlight(layer)}else{layer.setStyle(layer.options.previousOptions);delete layer.options.previousOptions}}if(layer instanceof L.Marker){layer.dragging.disable();layer.off("dragend",this._onMarkerDragEnd,this).off("touchmove",this._onTouchMove,this).off("touchend",this._onMarkerDragEnd,this)}else{layer.editing.disable()}},_onMouseMove:function(e){
this._tooltip.updatePosition(e.latlng)},_onTouchMove:function(e){var touchEvent=e.originalEvent.changedTouches[0],layerPoint=this._map.mouseEventToLayerPoint(touchEvent),latlng=this._map.layerPointToLatLng(layerPoint);e.target.setLatLng(latlng)},_hasAvailableLayers:function(){return this._featureGroup.getLayers().length!==0}});L.EditToolbar.Delete=L.Handler.extend({statics:{TYPE:"remove"},includes:L.Mixin.Events,initialize:function(map,options){L.Handler.prototype.initialize.call(this,map);L.Util.setOptions(this,options);this._deletableLayers=this.options.featureGroup;if(!(this._deletableLayers instanceof L.FeatureGroup)){throw new Error("options.featureGroup must be a L.FeatureGroup")}this.type=L.EditToolbar.Delete.TYPE},enable:function(){if(this._enabled||!this._hasAvailableLayers()){return}this.fire("enabled",{handler:this.type});this._map.fire("draw:deletestart",{handler:this.type});L.Handler.prototype.enable.call(this);this._deletableLayers.on("layeradd",this._enableLayerDelete,this).on("layerremove",this._disableLayerDelete,this)},disable:function(){if(!this._enabled){return}this._deletableLayers.off("layeradd",this._enableLayerDelete,this).off("layerremove",this._disableLayerDelete,this);L.Handler.prototype.disable.call(this);this._map.fire("draw:deletestop",{handler:this.type});this.fire("disabled",{handler:this.type})},addHooks:function(){var map=this._map;if(map){map.getContainer().focus();this._deletableLayers.eachLayer(this._enableLayerDelete,this);this._deletedLayers=new L.LayerGroup;this._tooltip=new L.Tooltip(this._map);this._tooltip.updateContent({text:L.drawLocal.edit.handlers.remove.tooltip.text});this._map.on("mousemove",this._onMouseMove,this)}},removeHooks:function(){if(this._map){this._deletableLayers.eachLayer(this._disableLayerDelete,this);this._deletedLayers=null;this._tooltip.dispose();this._tooltip=null;this._map.off("mousemove",this._onMouseMove,this)}},revertLayers:function(){this._deletedLayers.eachLayer(function(layer){this._deletableLayers.addLayer(layer);layer.fire("revert-deleted",{layer:layer})},this)},save:function(){this._map.fire("draw:deleted",{layers:this._deletedLayers})},_enableLayerDelete:function(e){var layer=e.layer||e.target||e;layer.on("click",this._removeLayer,this)},_disableLayerDelete:function(e){var layer=e.layer||e.target||e;layer.off("click",this._removeLayer,this);this._deletedLayers.removeLayer(layer)},_removeLayer:function(e){var layer=e.layer||e.target||e;this._deletableLayers.removeLayer(layer);this._deletedLayers.addLayer(layer);layer.fire("deleted")},_onMouseMove:function(e){this._tooltip.updatePosition(e.latlng)},_hasAvailableLayers:function(){return this._deletableLayers.getLayers().length!==0}})})(window,document);(function(){L.labelVersion="0.2.2-dev",L.Label=L.Class.extend({includes:L.Mixin.Events,options:{className:"",clickable:!1,direction:"right",noHide:!1,offset:[12,-15],opacity:1,zoomAnimation:!0},initialize:function(t,e){L.setOptions(this,t),this._source=e,this._animated=L.Browser.any3d&&this.options.zoomAnimation,this._isOpen=!1},onAdd:function(t){this._map=t,this._pane=this._source instanceof L.Marker?t._panes.markerPane:t._panes.popupPane,this._container||this._initLayout(),this._pane.appendChild(this._container),this._initInteraction(),this._update(),this.setOpacity(this.options.opacity),t.on("moveend",this._onMoveEnd,this).on("viewreset",this._onViewReset,this),this._animated&&t.on("zoomanim",this._zoomAnimation,this),L.Browser.touch&&!this.options.noHide&&L.DomEvent.on(this._container,"click",this.close,this)},onRemove:function(t){this._pane.removeChild(this._container),t.off({zoomanim:this._zoomAnimation,moveend:this._onMoveEnd,viewreset:this._onViewReset},this),this._removeInteraction(),this._map=null},setLatLng:function(t){return this._latlng=L.latLng(t),this._map&&this._updatePosition(),this},setContent:function(t){return this._previousContent=this._content,this._content=t,this._updateContent(),this},close:function(){var t=this._map;t&&(L.Browser.touch&&!this.options.noHide&&L.DomEvent.off(this._container,"click",this.close),t.removeLayer(this))},updateZIndex:function(t){this._zIndex=t,this._container&&this._zIndex&&(this._container.style.zIndex=t)},setOpacity:function(t){this.options.opacity=t,this._container&&L.DomUtil.setOpacity(this._container,t)},_initLayout:function(){this._container=L.DomUtil.create("div","leaflet-label "+this.options.className+" leaflet-zoom-animated"),this.updateZIndex(this._zIndex)},_update:function(){this._map&&(this._container.style.visibility="hidden",this._updateContent(),this._updatePosition(),this._container.style.visibility="")},_updateContent:function(){this._content&&this._map&&this._prevContent!==this._content&&"string"==typeof this._content&&(this._container.innerHTML=this._content,this._prevContent=this._content,this._labelWidth=this._container.offsetWidth)},_updatePosition:function(){var t=this._map.latLngToLayerPoint(this._latlng);this._setPosition(t)},_setPosition:function(t){var e=this._map,i=this._container,n=e.latLngToContainerPoint(e.getCenter()),o=e.layerPointToContainerPoint(t),s=this.options.direction,a=this._labelWidth,l=L.point(this.options.offset);"right"===s||"auto"===s&&o.x<n.x?(L.DomUtil.addClass(i,"leaflet-label-right"),L.DomUtil.removeClass(i,"leaflet-label-left"),t=t.add(l)):(L.DomUtil.addClass(i,"leaflet-label-left"),L.DomUtil.removeClass(i,"leaflet-label-right"),t=t.add(L.point(-l.x-a,l.y))),L.DomUtil.setPosition(i,t)},_zoomAnimation:function(t){var e=this._map._latLngToNewLayerPoint(this._latlng,t.zoom,t.center).round();this._setPosition(e)},_onMoveEnd:function(){this._animated&&"auto"!==this.options.direction||this._updatePosition()},_onViewReset:function(t){t&&t.hard&&this._update()},_initInteraction:function(){if(this.options.clickable){var t=this._container,e=["dblclick","mousedown","mouseover","mouseout","contextmenu"];L.DomUtil.addClass(t,"leaflet-clickable"),L.DomEvent.on(t,"click",this._onMouseClick,this);for(var i=0;e.length>i;i++)L.DomEvent.on(t,e[i],this._fireMouseEvent,this)}},_removeInteraction:function(){if(this.options.clickable){var t=this._container,e=["dblclick","mousedown","mouseover","mouseout","contextmenu"];L.DomUtil.removeClass(t,"leaflet-clickable"),L.DomEvent.off(t,"click",this._onMouseClick,this);for(var i=0;e.length>i;i++)L.DomEvent.off(t,e[i],this._fireMouseEvent,this)}},_onMouseClick:function(t){this.hasEventListeners(t.type)&&L.DomEvent.stopPropagation(t),this.fire(t.type,{originalEvent:t})},_fireMouseEvent:function(t){this.fire(t.type,{originalEvent:t}),"contextmenu"===t.type&&this.hasEventListeners(t.type)&&L.DomEvent.preventDefault(t),"mousedown"!==t.type?L.DomEvent.stopPropagation(t):L.DomEvent.preventDefault(t)}}),L.BaseMarkerMethods={showLabel:function(){return this.label&&this._map&&(this.label.setLatLng(this._latlng),this._map.showLabel(this.label)),this},hideLabel:function(){return this.label&&this.label.close(),this},setLabelNoHide:function(t){this._labelNoHide!==t&&(this._labelNoHide=t,t?(this._removeLabelRevealHandlers(),this.showLabel()):(this._addLabelRevealHandlers(),this.hideLabel()))},bindLabel:function(t,e){var i=this.options.icon?this.options.icon.options.labelAnchor:this.options.labelAnchor,n=L.point(i)||L.point(0,0);return n=n.add(L.Label.prototype.options.offset),e&&e.offset&&(n=n.add(e.offset)),e=L.Util.extend({offset:n},e),this._labelNoHide=e.noHide,this.label||(this._labelNoHide||this._addLabelRevealHandlers(),this.on("remove",this.hideLabel,this).on("move",this._moveLabel,this).on("add",this._onMarkerAdd,this),this._hasLabelHandlers=!0),this.label=new L.Label(e,this).setContent(t),this},unbindLabel:function(){return this.label&&(this.hideLabel(),this.label=null,this._hasLabelHandlers&&(this._labelNoHide||this._removeLabelRevealHandlers(),this.off("remove",this.hideLabel,this).off("move",this._moveLabel,this).off("add",this._onMarkerAdd,this)),this._hasLabelHandlers=!1),this},updateLabelContent:function(t){this.label&&this.label.setContent(t)},getLabel:function(){return this.label},_onMarkerAdd:function(){this._labelNoHide&&this.showLabel()},_addLabelRevealHandlers:function(){this.on("mouseover",this.showLabel,this).on("mouseout",this.hideLabel,this),L.Browser.touch&&this.on("click",this.showLabel,this)},_removeLabelRevealHandlers:function(){this.off("mouseover",this.showLabel,this).off("mouseout",this.hideLabel,this),L.Browser.touch&&this.off("click",this.showLabel,this)},_moveLabel:function(t){this.label.setLatLng(t.latlng)}},L.Icon.Default.mergeOptions({labelAnchor:new L.Point(9,-20)}),L.Marker.mergeOptions({icon:new L.Icon.Default}),L.Marker.include(L.BaseMarkerMethods),L.Marker.include({_originalUpdateZIndex:L.Marker.prototype._updateZIndex,_updateZIndex:function(t){var e=this._zIndex+t;this._originalUpdateZIndex(t),this.label&&this.label.updateZIndex(e)},_originalSetOpacity:L.Marker.prototype.setOpacity,setOpacity:function(t,e){this.options.labelHasSemiTransparency=e,this._originalSetOpacity(t)},_originalUpdateOpacity:L.Marker.prototype._updateOpacity,_updateOpacity:function(){var t=0===this.options.opacity?0:1;this._originalUpdateOpacity(),this.label&&this.label.setOpacity(this.options.labelHasSemiTransparency?this.options.opacity:t)},_originalSetLatLng:L.Marker.prototype.setLatLng,setLatLng:function(t){return this.label&&!this._labelNoHide&&this.hideLabel(),this._originalSetLatLng(t)}}),L.CircleMarker.mergeOptions({labelAnchor:new L.Point(0,0)}),L.CircleMarker.include(L.BaseMarkerMethods),L.Path.include({bindLabel:function(t,e){return this.label&&this.label.options===e||(this.label=new L.Label(e,this)),this.label.setContent(t),this._showLabelAdded||(this.on("mouseover",this._showLabel,this).on("mousemove",this._moveLabel,this).on("mouseout remove",this._hideLabel,this),L.Browser.touch&&this.on("click",this._showLabel,this),this._showLabelAdded=!0),this},unbindLabel:function(){return this.label&&(this._hideLabel(),this.label=null,this._showLabelAdded=!1,this.off("mouseover",this._showLabel,this).off("mousemove",this._moveLabel,this).off("mouseout remove",this._hideLabel,this)),this},updateLabelContent:function(t){this.label&&this.label.setContent(t)},_showLabel:function(t){this.label.setLatLng(t.latlng),this._map.showLabel(this.label)},_moveLabel:function(t){this.label.setLatLng(t.latlng)},_hideLabel:function(){this.label.close()}}),L.Map.include({showLabel:function(t){return this.addLayer(t)}}),L.FeatureGroup.include({clearLayers:function(){return this.unbindLabel(),this.eachLayer(this.removeLayer,this),this},bindLabel:function(t,e){return this.invoke("bindLabel",t,e)},unbindLabel:function(){return this.invoke("unbindLabel")},updateLabelContent:function(t){this.invoke("updateLabelContent",t)}})})(this,document);(function(window,document,undefined){L.print=L.print||{};L.print.Provider=L.Class.extend({includes:L.Mixin.Events,statics:{MAX_RESOLUTION:156543.03390625,MAX_EXTENT:[-20037508.34,-20037508.34,20037508.34,20037508.34],SRS:"EPSG:3857",INCHES_PER_METER:39.3701,DPI:72,UNITS:"m"},options:{autoLoad:false,autoOpen:true,outputFormat:"pdf",outputFilename:"leaflet-map",method:"POST",rotation:0,customParams:{},legends:false},initialize:function(options){if(L.version<="0.5.1"){throw"Leaflet.print requires Leaflet 0.6.0+. Download latest from https://github.com/Leaflet/Leaflet/"}var context;options=L.setOptions(this,options);if(options.map){this.setMap(options.map)}if(options.capabilities){this._capabilities=options.capabilities}else if(this.options.autoLoad){this.loadCapabilities()}if(options.listeners){if(options.listeners.context){context=options.listeners.context;delete options.listeners.context}this.addEventListener(options.listeners,context)}},loadCapabilities:function(){if(!this.options.url){return}var url;url=this.options.url+"/info.json";if(this.options.proxy){url=this.options.proxy+url}$.ajax({type:"GET",dataType:"json",url:url,success:L.Util.bind(this.onCapabilitiesLoad,this)})},print:function(options){options=L.extend(L.extend({},this.options),options);if(!options.layout||!options.dpi){throw"Must provide a layout name and dpi value to print"}this.fire("beforeprint",{provider:this,map:this._map});var jsonData=JSON.stringify(L.extend({units:L.print.Provider.UNITS,srs:L.print.Provider.SRS,layout:options.layout,dpi:options.dpi,outputFormat:options.outputFormat,outputFilename:options.outputFilename,layers:this._encodeLayers(this._map),pages:[{center:this._projectCoords(L.print.Provider.SRS,this._map.getCenter()),scale:this._getScale(),rotation:options.rotation}]},this.options.customParams,options.customParams,this._makeLegends(this._map))),url;if(options.method==="GET"){url=this._capabilities.printURL+"?spec="+encodeURIComponent(jsonData);if(options.proxy){url=options.proxy+encodeURIComponent(url)}window.open(url);this.fire("print",{provider:this,map:this._map})}else{url=this._capabilities.createURL;if(options.proxy){url=options.proxy+url}if(this._xhr){this._xhr.abort()}this._xhr=$.ajax({type:"POST",contentType:"application/json; charset=UTF-8",processData:false,dataType:"json",url:url,data:jsonData,success:L.Util.bind(this.onPrintSuccess,this),error:L.Util.bind(this.onPrintError,this)})}},getJson:function(options){options=L.extend(L.extend({},this.options),options);if(!options.layout||!options.dpi){throw"Must provide a layout name and dpi value to print"}this.fire("beforeprint",{provider:this,map:this._map});var jsonData=L.extend({units:L.print.Provider.UNITS,srs:L.print.Provider.SRS,layout:options.layout,dpi:options.dpi,outputFormat:options.outputFormat,outputFilename:options.outputFilename,layers:this._encodeLayers(this._map),pages:[{center:this._projectCoords(L.print.Provider.SRS,this._map.getCenter()),scale:this._getScale(),rotation:options.rotation}]},this.options.customParams,options.customParams,this._makeLegends(this._map));return jsonData},getCapabilities:function(){return this._capabilities},setMap:function(map){this._map=map},setDpi:function(dpi){var oldDpi=this.options.dpi;if(oldDpi!==dpi){this.options.dpi=dpi;this.fire("dpichange",{provider:this,dpi:dpi})}},setLayout:function(name){var oldName=this.options.layout;if(oldName!==name){this.options.layout=name;this.fire("layoutchange",{provider:this,layout:name})}},setRotation:function(rotation){var oldRotation=this.options.rotation;if(oldRotation!==this.options.rotation){this.options.rotation=rotation;this.fire("rotationchange",{provider:this,rotation:rotation})}},_getLayers:function(map){var markers=[],vectors=[],tiles=[],imageOverlays=[],imageNodes,pathNodes,id;for(id in map._layers){if(map._layers.hasOwnProperty(id)){if(!map._layers.hasOwnProperty(id)){continue}var lyr=map._layers[id];if(lyr instanceof L.TileLayer.WMS||lyr instanceof L.TileLayer){tiles.push(lyr)}else if(lyr instanceof L.ImageOverlay){imageOverlays.push(lyr)}else if(lyr instanceof L.Marker){markers.push(lyr)}else if(lyr instanceof L.Path&&lyr.toGeoJSON){vectors.push(lyr)}}}markers.sort(function(a,b){return a._icon.style.zIndex-b._icon.style.zIndex});var i;for(i=1;i<markers.length;i++){if(markers[i]._icon.style.zIndex<=markers[i-1]._icon.style.zIndex){markers[i]._icon.style.zIndex=markers[i-1].icons.style.zIndex+1}}tiles.sort(function(a,b){return a._container.style.zIndex-b._container.style.zIndex});for(i=1;i<tiles.length;i++){if(tiles[i]._container.style.zIndex<=tiles[i-1]._container.style.zIndex){tiles[i]._container.style.zIndex=tiles[i-1]._container.style.zIndex+1}}imageNodes=[].slice.call(this,map._panes.overlayPane.childNodes);imageOverlays.sort(function(a,b){return imageNodes.indexOf(a._image)-imageNodes.indexOf(b._image)});if(map._pathRoot){pathNodes=[].slice.call(this,map._pathRoot.childNodes);vectors.sort(function(a,b){return pathNodes.indexOf(a._container)-pathNodes.indexOf(b._container)})}return tiles.concat(vectors).concat(imageOverlays).concat(markers)},_getScale:function(){var map=this._map,bounds=map.getBounds(),inchesKm=L.print.Provider.INCHES_PER_METER*1e3,scales=this._capabilities.scales,sw=bounds.getSouthWest(),ne=bounds.getNorthEast(),halfLat=(sw.lat+ne.lat)/2,midLeft=L.latLng(halfLat,sw.lng),midRight=L.latLng(halfLat,ne.lng),mwidth=midLeft.distanceTo(midRight),pxwidth=map.getSize().x,kmPx=mwidth/pxwidth/1e3,mscale=(kmPx||1e-6)*inchesKm*L.print.Provider.DPI,closest=Number.POSITIVE_INFINITY,i=scales.length,diff,scale;while(i--){diff=Math.abs(mscale-scales[i].value);if(diff<closest){closest=diff;scale=parseInt(scales[i].value,10)}}return scale},_getLayoutByName:function(name){var layout,i,l;for(i=0,l=this._capabilities.layouts.length;i<l;i++){if(this._capabilities.layouts[i].name===name){layout=this._capabilities.layouts[i];break}}return layout},_encodeLayers:function(map){var enc=[],vectors=[],layer,i;var layers=this._getLayers(map);for(i=0;i<layers.length;i++){layer=layers[i];if(layer instanceof L.TileLayer.WMS){enc.push(this._encoders.layers.tilelayerwms.call(this,layer))}else if(L.mapbox&&layer instanceof L.mapbox.TileLayer){enc.push(this._encoders.layers.tilelayermapbox.call(this,layer))}else if(layer instanceof L.TileLayer){enc.push(this._encoders.layers.tilelayer.call(this,layer))}else if(layer instanceof L.ImageOverlay){enc.push(this._encoders.layers.image.call(this,layer))}else if(layer instanceof L.Marker||layer instanceof L.Path&&layer.toGeoJSON){vectors.push(layer)}}if(vectors.length){enc.push(this._encoders.layers.vector.call(this,vectors))}return enc},_makeLegends:function(map,options){if(!this.options.legends){return[]}var legends=[],legendReq,singlelayers,url,i;var layers=this._getLayers(map);var layer,oneLegend;for(i=0;i<layers.length;i++){layer=layers[i];if(layer instanceof L.TileLayer.WMS){oneLegend={name:layer.options.title||layer.wmsParams.layers,classes:[]};legendReq={SERVICE:"WMS",LAYER:layer.wmsParams.layers,REQUEST:"GetLegendGraphic",VERSION:layer.wmsParams.version,FORMAT:layer.wmsParams.format,STYLE:layer.wmsParams.styles,WIDTH:15,HEIGHT:15};legendReq=L.extend(legendReq,options);url=L.Util.template(layer._url);singlelayers=layer.wmsParams.layers.split(",");if(singlelayers.length===1){oneLegend.icons=[this._getAbsoluteUrl(url+L.Util.getParamString(legendReq,url,true))]}else{for(i=0;i<singlelayers.length;i++){legendReq.LAYER=singlelayers[i];oneLegend.classes.push({name:singlelayers[i],icons:[this._getAbsoluteUrl(url+L.Util.getParamString(legendReq,url,true))]})}}legends.push(oneLegend)}}return{legends:legends}},_encoders:{layers:{httprequest:function(layer){var baseUrl=layer._url;if(baseUrl.indexOf("{s}")!==-1){baseUrl=baseUrl.replace("{s}",layer.options.subdomains[0])}baseUrl=this._getAbsoluteUrl(baseUrl);return{baseURL:baseUrl,opacity:layer.options.opacity}},tilelayer:function(layer){var enc=this._encoders.layers.httprequest.call(this,layer),baseUrl=layer._url.substring(0,layer._url.indexOf("{z}")),resolutions=[],zoom,split,layerName;if(baseUrl.indexOf("{s}")!==-1){baseUrl=baseUrl.replace("{s}",layer.options.subdomains[0])}for(zoom=0;zoom<=layer.options.maxZoom;++zoom){resolutions.push(L.print.Provider.MAX_RESOLUTION/Math.pow(2,zoom))}if(layer.options.tms){split=baseUrl.split("/");layerName=split[split.length-2];split.splice(-3);baseUrl=split.join("/")+"/";return L.extend(enc,{type:"TMS",baseURL:baseUrl,layer:layerName,format:"png",tileSize:[layer.options.tileSize,layer.options.tileSize],maxExtent:L.print.Provider.MAX_EXTENT,resolutions:resolutions,tileOrigin:{x:L.print.Provider.MAX_EXTENT[0],y:L.print.Provider.MAX_EXTENT[0]},singleTile:false})}else{return L.extend(enc,{type:"OSM",baseURL:baseUrl,extension:"png",tileSize:[layer.options.tileSize,layer.options.tileSize],maxExtent:L.print.Provider.MAX_EXTENT,resolutions:resolutions,tileOrigin:{x:L.print.Provider.MAX_EXTENT[0],y:L.print.Provider.MAX_EXTENT[0]},singleTile:false})}},tilelayerwms:function(layer){var enc=this._encoders.layers.httprequest.call(this,layer),layerOpts=layer.options,p;L.extend(enc,{type:"WMS",layers:[layerOpts.layers].join(",").split(",").filter(function(x){return x!==""}),format:layerOpts.format,styles:[layerOpts.styles].join(",").split(",").filter(function(x){return x!==""}),singleTile:false});for(p in layer.wmsParams){if(layer.wmsParams.hasOwnProperty(p)){if("detectretina,format,height,layers,request,service,srs,styles,version,width".indexOf(p.toLowerCase())===-1){if(!enc.customParams){enc.customParams={}}enc.customParams[p]=layer.wmsParams[p]}}}return enc},tilelayermapbox:function(layer){var resolutions=[],zoom;for(zoom=0;zoom<=layer.options.maxZoom;++zoom){resolutions.push(L.print.Provider.MAX_RESOLUTION/Math.pow(2,zoom))}var customParams={};if(typeof layer.options.access_token==="string"&&layer.options.access_token.length>0){customParams.access_token=layer.options.access_token}return{type:"OSM",baseURL:layer.options.tiles[0].substring(0,layer.options.tiles[0].indexOf("{z}")),opacity:layer.options.opacity,extension:"png",tileSize:[layer.options.tileSize,layer.options.tileSize],maxExtent:L.print.Provider.MAX_EXTENT,resolutions:resolutions,singleTile:false,customParams:customParams}},image:function(layer){return{type:"Image",opacity:layer.options.opacity,name:"image",baseURL:this._getAbsoluteUrl(layer._url),extent:this._projectBounds(L.print.Provider.SRS,layer._bounds)}},vector:function(features){var encFeatures=[],encStyles={},opacity,feature,style,dictKey,dictItem={},styleDict={},styleName,nextId=1,featureGeoJson,i,l;for(i=0,l=features.length;i<l;i++){feature=features[i];if(feature instanceof L.Marker){var icon=feature.options.icon,iconUrl=icon.options.iconUrl||L.Icon.Default.imagePath+"/marker-icon.png",iconSize=L.Util.isArray(icon.options.iconSize)?new L.Point(icon.options.iconSize[0],icon.options.iconSize[1]):icon.options.iconSize,iconAnchor=L.Util.isArray(icon.options.iconAnchor)?new L.Point(icon.options.iconAnchor[0],icon.options.iconAnchor[1]):icon.options.iconAnchor,scaleFactor=this.options.dpi/L.print.Provider.DPI;style={externalGraphic:this._getAbsoluteUrl(iconUrl),graphicWidth:iconSize.x/scaleFactor,graphicHeight:iconSize.y/scaleFactor,graphicXOffset:-iconAnchor.x/scaleFactor,graphicYOffset:-iconAnchor.y/scaleFactor}}else{style=this._extractFeatureStyle(feature)}dictKey=JSON.stringify(style);dictItem=styleDict[dictKey];if(dictItem){styleName=dictItem}else{styleDict[dictKey]=styleName=nextId++;encStyles[styleName]=style}featureGeoJson=feature instanceof L.Circle?this._circleGeoJSON(feature):feature.toGeoJSON();featureGeoJson.geometry.coordinates=this._projectCoords(L.print.Provider.SRS,featureGeoJson.geometry.coordinates);featureGeoJson.properties._leaflet_style=styleName;if(opacity===null){opacity=feature.options.opacity||1}encFeatures.push(featureGeoJson)}return{type:"Vector",styles:encStyles,opacity:opacity,styleProperty:"_leaflet_style",geoJson:{type:"FeatureCollection",features:encFeatures}}}}},_circleGeoJSON:function(circle){var projection=circle._map.options.crs.projection;var earthRadius=1,i;if(projection===L.Projection.SphericalMercator){earthRadius=6378137}else if(projection===L.Projection.Mercator){earthRadius=projection.R_MAJOR}var cnt=projection.project(circle.getLatLng());var scale=1/Math.cos(circle.getLatLng().lat*Math.PI/180);var points=[];for(i=0;i<64;i++){var radian=i*2*Math.PI/64;var shift=L.point(Math.cos(radian),Math.sin(radian));points.push(projection.unproject(cnt.add(shift.multiplyBy(circle.getRadius()*scale/earthRadius))))}return L.polygon(points).toGeoJSON()},_extractFeatureStyle:function(feature){var options=feature.options;return{stroke:options.stroke,strokeColor:options.color,strokeWidth:options.weight,strokeOpacity:options.opacity,strokeLinecap:"round",fill:options.fill,fillColor:options.fillColor||options.color,fillOpacity:options.fillOpacity}},_getAbsoluteUrl:function(url){var a;if(L.Browser.ie){a=document.createElement("a");a.style.display="none";document.body.appendChild(a);a.href=url;document.body.removeChild(a)}else{a=document.createElement("a");a.href=url}return a.href},_projectBounds:function(crs,bounds){var sw=bounds.getSouthWest(),ne=bounds.getNorthEast();return this._projectCoords(crs,sw).concat(this._projectCoords(crs,ne))},_projectCoords:function(crs,coords){var crsKey=crs.toUpperCase().replace(":",""),crsClass=L.CRS[crsKey];if(!crsClass){throw"Unsupported coordinate reference system: "+crs}return this._project(crsClass,coords)},_project:function(crsClass,coords){var projected,pt,i,l;if(typeof coords[0]==="number"){coords=new L.LatLng(coords[1],coords[0])}if(coords instanceof L.LatLng){pt=crsClass.project(coords);return[pt.x,pt.y]}else{projected=[];for(i=0,l=coords.length;i<l;i++){projected.push(this._project(crsClass,coords[i]))}return projected}},onCapabilitiesLoad:function(response){this._capabilities=response;if(!this.options.layout){this.options.layout=this._capabilities.layouts[0].name}if(!this.options.dpi){this.options.dpi=this._capabilities.dpis[0].value}this.fire("capabilitiesload",{provider:this,capabilities:this._capabilities})},onPrintSuccess:function(response){var url=response.getURL+(L.Browser.ie?"?inline=true":"");if(this.options.autoOpen){if(L.Browser.ie){window.open(url)}else{window.location.href=url}}this._xhr=null;this.fire("print",{provider:this,response:response})},onPrintError:function(jqXHR){this._xhr=null;this.fire("printexception",{provider:this,response:jqXHR})}});L.print.provider=function(options){return new L.print.Provider(options)};L.Control.Print=L.Control.extend({options:{position:"topleft",showLayouts:true},initialize:function(options){L.Control.prototype.initialize.call(this,options);this._actionButtons={};this._actionsVisible=false;if(this.options.provider&&this.options.provider instanceof L.print.Provider){this._provider=this.options.provider}else{this._provider=L.print.Provider(this.options.provider||{})}},onAdd:function(map){var capabilities,container=L.DomUtil.create("div","leaflet-control-print"),toolbarContainer=L.DomUtil.create("div","leaflet-bar",container),link;this._toolbarContainer=toolbarContainer;link=L.DomUtil.create("a","leaflet-print-print",toolbarContainer);link.href="#";link.title="Print map";L.DomEvent.on(link,"click",L.DomEvent.stopPropagation).on(link,"mousedown",L.DomEvent.stopPropagation).on(link,"dblclick",L.DomEvent.stopPropagation).on(link,"click",L.DomEvent.preventDefault).on(link,"click",this.onPrint,this);if(this.options.showLayouts){capabilities=this._provider.getCapabilities();if(!capabilities){this._provider.once("capabilitiesload",this.onCapabilitiesLoad,this)}else{this._createActions(container,capabilities)}}this._provider.setMap(map);return container},onRemove:function(){var buttonId,button;for(buttonId in this._actionButtons){if(this._actionButtons.hasOwnProperty(buttonId)){button=this._actionButtons[buttonId];this._disposeButton(button.button,button.callback,button.scope)}}this._actionButtons={};this._actionsContainer=null},getProvider:function(){return this._provider},_createActions:function(container,capabilities){var layouts=capabilities.layouts,l=layouts.length,actionsContainer=L.DomUtil.create("ul","leaflet-print-actions",container),buttonWidth=100,containerWidth=l*buttonWidth+(l-1),button,li,i;actionsContainer.style.width=containerWidth+"px";for(i=0;i<l;i++){li=L.DomUtil.create("li","",actionsContainer);button=this._createButton({title:"Print map using the "+layouts[i].name+" layout",text:this._ellipsis(layouts[i].name,16),container:li,callback:this.onActionClick,context:this});this._actionButtons[L.stamp(button)]={name:layouts[i].name,button:button,callback:this.onActionClick,context:this}}this._actionsContainer=actionsContainer},_createButton:function(options){var link=L.DomUtil.create("a",options.className||"",options.container);link.href="#";if(options.text){link.innerHTML=options.text}if(options.title){link.title=options.title}L.DomEvent.on(link,"click",L.DomEvent.stopPropagation).on(link,"mousedown",L.DomEvent.stopPropagation).on(link,"dblclick",L.DomEvent.stopPropagation).on(link,"click",L.DomEvent.preventDefault).on(link,"click",options.callback,options.context);return link},_showActionsToolbar:function(){L.DomUtil.addClass(this._toolbarContainer,"leaflet-print-actions-visible");this._actionsContainer.style.display="block";this._actionsVisible=true},_hideActionsToolbar:function(){this._actionsContainer.style.display="none";L.DomUtil.removeClass(this._toolbarContainer,"leaflet-print-actions-visible");this._actionsVisible=false},_ellipsis:function(value,len){if(value&&value.length>len){value=value.substr(0,len-3)+"..."}return value},onCapabilitiesLoad:function(event){this._createActions(this._container,event.capabilities)},onActionClick:function(event){var id=""+L.stamp(event.target),button,buttonId;for(buttonId in this._actionButtons){if(this._actionButtons.hasOwnProperty(buttonId)&&buttonId===id){button=this._actionButtons[buttonId];this._provider.print({layout:button.name});break}}this._hideActionsToolbar()},onPrint:function(){if(this.options.showLayouts){if(!this._actionsVisible){this._showActionsToolbar()}else{this._hideActionsToolbar()}}else{this._provider.print()}}});L.control.print=function(options){return new L.Control.Print(options)}})(this,document);L.Editable=L.Class.extend({includes:[L.Mixin.Events],statics:{FORWARD:1,BACKWARD:-1},options:{zIndex:1e3,polygonClass:L.Polygon,polylineClass:L.Polyline,markerClass:L.Marker,drawingCSSClass:"leaflet-editable-drawing"},initialize:function(map,options){L.setOptions(this,options);this._lastZIndex=this.options.zIndex;this.map=map;this.editLayer=this.createEditLayer();this.featuresLayer=this.createFeaturesLayer();this.newClickHandler=this.createNewClickHandler();this.forwardLineGuide=this.createLineGuide();this.backwardLineGuide=this.createLineGuide()},fireAndForward:function(type,e){e=e||{};e.editTools=this;this.fire(type,e);this.map.fire(type,e)},createLineGuide:function(){var options=L.extend({dashArray:"5,10",weight:1},this.options.lineGuideOptions);return L.polyline([],options)},createVertexIcon:function(options){return L.Browser.touch?new L.Editable.TouchVertexIcon(options):new L.Editable.VertexIcon(options)},createNewClickHandler:function(){return L.marker(this.map.getCenter(),{icon:this.createVertexIcon({className:"leaflet-div-icon leaflet-drawing-icon"}),opacity:0,zIndexOffset:this._lastZIndex})},createEditLayer:function(){return this.options.editLayer||(new L.LayerGroup).addTo(this.map)},createFeaturesLayer:function(){return this.options.featuresLayer||(new L.LayerGroup).addTo(this.map)},moveForwardLineGuide:function(latlng){if(this.forwardLineGuide._latlngs.length){this.forwardLineGuide._latlngs[1]=latlng;this.forwardLineGuide.redraw()}},moveBackwardLineGuide:function(latlng){if(this.backwardLineGuide._latlngs.length){this.backwardLineGuide._latlngs[1]=latlng;this.backwardLineGuide.redraw()}},anchorForwardLineGuide:function(latlng){this.forwardLineGuide._latlngs[0]=latlng;this.forwardLineGuide.redraw()},anchorBackwardLineGuide:function(latlng){this.backwardLineGuide._latlngs[0]=latlng;this.backwardLineGuide.redraw()},attachForwardLineGuide:function(){this.editLayer.addLayer(this.forwardLineGuide)},attachBackwardLineGuide:function(){this.editLayer.addLayer(this.backwardLineGuide)},detachForwardLineGuide:function(){this.forwardLineGuide._latlngs=[];this.editLayer.removeLayer(this.forwardLineGuide)},detachBackwardLineGuide:function(){this.backwardLineGuide._latlngs=[];this.editLayer.removeLayer(this.backwardLineGuide)},updateNewClickHandlerZIndex:function(){this._lastZIndex+=2;this.newClickHandler.setZIndexOffset(this._lastZIndex)},registerForDrawing:function(editor){this.map.on("mousemove touchmove",editor.onMouseMove,editor);if(this._drawingEditor)this.unregisterForDrawing(this._drawingEditor);this._drawingEditor=editor;this.editLayer.addLayer(this.newClickHandler);this.newClickHandler.on("click",editor.onNewClickHandlerClicked,editor);if(L.Browser.touch)this.map.on("click",editor.onTouch,editor);L.DomUtil.addClass(this.map._container,this.options.drawingCSSClass);this.updateNewClickHandlerZIndex()},unregisterForDrawing:function(editor){editor=editor||this._drawingEditor;this.editLayer.removeLayer(this.newClickHandler)
;if(!editor)return;this.map.off("mousemove touchmove",editor.onMouseMove,editor);this.newClickHandler.off("click",editor.onNewClickHandlerClicked,editor);if(L.Browser.touch)this.map.off("click",editor.onTouch,editor);if(editor!==this._drawingEditor)return;delete this._drawingEditor;if(editor.drawing)editor.cancelDrawing();L.DomUtil.removeClass(this.map._container,this.options.drawingCSSClass)},stopDrawing:function(){this.unregisterForDrawing()},connectCreatedToMap:function(layer){return this.featuresLayer.addLayer(layer)},startPolyline:function(latlng,options){var line=this.createPolyline([],options);this.connectCreatedToMap(line);var editor=line.enableEdit();editor.startDrawingForward();if(latlng)editor.newPointForward(latlng);return line},startPolygon:function(latlng,options){var polygon=this.createPolygon([],options);this.connectCreatedToMap(polygon);var editor=polygon.enableEdit();editor.startDrawingForward();if(latlng)editor.newPointForward(latlng);return polygon},startMarker:function(latlng,options){latlng=latlng||this.map.getCenter();var marker=this.createMarker(latlng,options);this.connectCreatedToMap(marker);var editor=marker.enableEdit();editor.startDrawing();return marker},startHole:function(editor,latlng){editor.newHole(latlng)},extendMultiPolygon:function(multi){var polygon=this.createPolygon([]);multi.addLayer(polygon);polygon.multi=multi;var editor=polygon.enableEdit();editor.startDrawingForward();return polygon},createPolyline:function(latlngs,options){options=L.Util.extend({editOptions:{editTools:this}},options);var line=new this.options.polylineClass(latlngs,options);this.fireAndForward("editable:created",{layer:line});return line},createPolygon:function(latlngs,options){options=L.Util.extend({editOptions:{editTools:this}},options);var polygon=new this.options.polygonClass(latlngs,options);this.fireAndForward("editable:created",{layer:polygon});return polygon},createMarker:function(latlng,options){options=L.Util.extend({editOptions:{editTools:this}},options);var marker=new this.options.markerClass(latlng,options);this.fireAndForward("editable:created",{layer:marker});return marker}});L.Map.addInitHook(function(){this.whenReady(function(){if(this.options.editable){this.editTools=new L.Editable(this,this.options.editOptions)}})});L.Editable.VertexIcon=L.DivIcon.extend({options:{iconSize:new L.Point(8,8)}});L.Editable.TouchVertexIcon=L.Editable.VertexIcon.extend({options:{iconSize:new L.Point(20,20)}});L.Editable.VertexMarker=L.Marker.extend({options:{draggable:true,className:"leaflet-div-icon leaflet-vertex-icon"},initialize:function(latlng,latlngs,editor,options){this.latlng=latlng;this.latlngs=latlngs;this.editor=editor;L.Marker.prototype.initialize.call(this,latlng,options);this.options.icon=this.editor.tools.createVertexIcon({className:this.options.className});this.latlng.__vertex=this;this.editor.editLayer.addLayer(this);this.setZIndexOffset(editor.tools._lastZIndex+1)},onAdd:function(map){L.Marker.prototype.onAdd.call(this,map);this.on("drag",this.onDrag);this.on("dragstart",this.onDragStart);this.on("dragend",this.onDragEnd);this.on("click",this.onClick);this.on("contextmenu",this.onContextMenu);this.on("mousedown touchstart",this.onMouseDown);this.addMiddleMarkers()},onRemove:function(map){if(this.middleMarker)this.middleMarker.delete();delete this.latlng.__vertex;this.off("drag",this.onDrag);this.off("dragstart",this.onDragStart);this.off("dragend",this.onDragEnd);this.off("click",this.onClick);this.off("contextmenu",this.onContextMenu);this.off("mousedown touchstart",this.onMouseDown);L.Marker.prototype.onRemove.call(this,map)},onDrag:function(e){e.vertex=this;this.editor.onVertexMarkerDrag(e);var iconPos=L.DomUtil.getPosition(this._icon),latlng=this._map.layerPointToLatLng(iconPos);this.latlng.lat=latlng.lat;this.latlng.lng=latlng.lng;this.editor.refresh();if(this.middleMarker){this.middleMarker.updateLatLng()}var next=this.getNext();if(next&&next.middleMarker){next.middleMarker.updateLatLng()}},onDragStart:function(e){e.vertex=this;this.editor.onVertexMarkerDragStart(e)},onDragEnd:function(e){e.vertex=this;this.editor.onVertexMarkerDragEnd(e)},onClick:function(e){e.vertex=this;this.editor.onVertexMarkerClick(e)},onContextMenu:function(e){e.vertex=this;this.editor.onVertexMarkerContextMenu(e)},onMouseDown:function(e){e.vertex=this;this.editor.onVertexMarkerMouseDown(e)},delete:function(){var next=this.getNext();this.latlngs.splice(this.latlngs.indexOf(this.latlng),1);this.editor.editLayer.removeLayer(this);this.editor.onVertexDeleted({latlng:this.latlng,vertex:this});if(next)next.resetMiddleMarker()},getIndex:function(){return this.latlngs.indexOf(this.latlng)},getLastIndex:function(){return this.latlngs.length-1},getPrevious:function(){if(this.latlngs.length<2)return;var index=this.getIndex(),previousIndex=index-1;if(index===0&&this.editor.CLOSED)previousIndex=this.getLastIndex();var previous=this.latlngs[previousIndex];if(previous)return previous.__vertex},getNext:function(){if(this.latlngs.length<2)return;var index=this.getIndex(),nextIndex=index+1;if(index===this.getLastIndex()&&this.editor.CLOSED)nextIndex=0;var next=this.latlngs[nextIndex];if(next)return next.__vertex},addMiddleMarker:function(previous){previous=previous||this.getPrevious();if(previous&&!this.middleMarker)this.middleMarker=this.editor.addMiddleMarker(previous,this,this.latlngs,this.editor)},addMiddleMarkers:function(){if(this.editor.tools.options.skipMiddleMarkers)return;var previous=this.getPrevious();if(previous){this.addMiddleMarker(previous)}var next=this.getNext();if(next){next.resetMiddleMarker()}},resetMiddleMarker:function(){if(this.middleMarker)this.middleMarker.delete();this.addMiddleMarker()},_initInteraction:function(){L.Marker.prototype._initInteraction.call(this);L.DomEvent.on(this._icon,"touchstart",function(e){this._fireMouseEvent(e)},this)}});L.Editable.mergeOptions({vertexMarkerClass:L.Editable.VertexMarker});L.Editable.MiddleMarker=L.Marker.extend({options:{opacity:.5,className:"leaflet-div-icon leaflet-middle-icon"},initialize:function(left,right,latlngs,editor,options){this.left=left;this.right=right;this.editor=editor;this.latlngs=latlngs;L.Marker.prototype.initialize.call(this,this.computeLatLng(),options);this._opacity=this.options.opacity;this.options.icon=this.editor.tools.createVertexIcon({className:this.options.className});this.editor.editLayer.addLayer(this);this.setVisibility()},setVisibility:function(){var leftPoint=this._map.latLngToContainerPoint(this.left.latlng),rightPoint=this._map.latLngToContainerPoint(this.right.latlng),size=L.point(this.options.icon.options.iconSize);if(leftPoint.distanceTo(rightPoint)<size.x*3){this.hide()}else{this.show()}},show:function(){this.setOpacity(this._opacity)},hide:function(){this.setOpacity(0)},updateLatLng:function(){this.setLatLng(this.computeLatLng());this.setVisibility()},computeLatLng:function(){var leftPoint=this.editor.map.latLngToContainerPoint(this.left.latlng),rightPoint=this.editor.map.latLngToContainerPoint(this.right.latlng),y=(leftPoint.y+rightPoint.y)/2,x=(leftPoint.x+rightPoint.x)/2;return this.editor.map.containerPointToLatLng([x,y])},onAdd:function(map){L.Marker.prototype.onAdd.call(this,map);this.on("mousedown touchstart",this.onMouseDown);map.on("zoomend",this.setVisibility,this)},onRemove:function(map){delete this.right.middleMarker;this.off("mousedown touchstart",this.onMouseDown);map.off("zoomend",this.setVisibility,this);L.Marker.prototype.onRemove.call(this,map)},onMouseDown:function(e){this.editor.onMiddleMarkerMouseDown(e,this);this.latlngs.splice(this.index(),0,e.latlng);this.editor.refresh();var marker=this.editor.addVertexMarker(e.latlng,this.latlngs);marker.dragging._draggable._onDown(e.originalEvent);this.delete()},delete:function(){this.editor.editLayer.removeLayer(this)},index:function(){return this.latlngs.indexOf(this.right.latlng)},_initInteraction:function(){L.Marker.prototype._initInteraction.call(this);L.DomEvent.on(this._icon,"touchstart",function(e){this._fireMouseEvent(e)},this)}});L.Editable.mergeOptions({middleMarkerClass:L.Editable.MiddleMarker});L.Editable.BaseEditor=L.Class.extend({initialize:function(map,feature,options){L.setOptions(this,options);this.map=map;this.feature=feature;this.feature.editor=this;this.editLayer=new L.LayerGroup;this.tools=this.options.editTools||map.editTools},enable:function(){if(this._enabled)return this;this.tools.editLayer.addLayer(this.editLayer);this.onEnable();this._enabled=true;this.feature.on("remove",this.disable,this);return this},disable:function(){this.feature.off("remove",this.disable,this);this.editLayer.clearLayers();this.tools.editLayer.removeLayer(this.editLayer);this.onDisable();delete this._enabled;if(this.drawing)this.cancelDrawing();return this},fireAndForward:function(type,e){e=e||{};e.layer=this.feature;this.feature.fire(type,e);if(this.feature.multi)this.feature.multi.fire(type,e);this.tools.fireAndForward(type,e)},onEnable:function(){this.fireAndForward("editable:enable")},onDisable:function(){this.fireAndForward("editable:disable")},onEditing:function(){this.fireAndForward("editable:editing")},onStartDrawing:function(){this.fireAndForward("editable:drawing:start")},onEndDrawing:function(){this.fireAndForward("editable:drawing:end")},onCancelDrawing:function(){this.fireAndForward("editable:drawing:cancel")},onCommitDrawing:function(){this.fireAndForward("editable:drawing:commit")},startDrawing:function(){if(!this.drawing)this.drawing=L.Editable.FORWARD;this.tools.registerForDrawing(this);this.onStartDrawing()},commitDrawing:function(){this.onCommitDrawing();this.endDrawing()},cancelDrawing:function(){this.onCancelDrawing();this.endDrawing()},endDrawing:function(){this.drawing=false;this.tools.unregisterForDrawing(this);this.onEndDrawing()},onMouseMove:function(e){if(this.drawing){this.tools.newClickHandler.setLatLng(e.latlng)}},onTouch:function(e){this.onMouseMove(e);if(this.drawing)this.tools.newClickHandler._fireMouseEvent(e)},onNewClickHandlerClicked:function(e){this.fireAndForward("editable:drawing:click",e)},isNewClickValid:function(latlng){return true}});L.Editable.MarkerEditor=L.Editable.BaseEditor.extend({enable:function(){if(this._enabled)return this;L.Editable.BaseEditor.prototype.enable.call(this);this.feature.dragging.enable();this.feature.on("dragstart",this.onEditing,this);return this},disable:function(){L.Editable.BaseEditor.prototype.disable.call(this);this.feature.dragging.disable();this.feature.off("dragstart",this.onEditing,this);return this},onMouseMove:function(e){if(this.drawing){L.Editable.BaseEditor.prototype.onMouseMove.call(this,e);this.feature.setLatLng(e.latlng);this.tools.newClickHandler._bringToFront()}},onNewClickHandlerClicked:function(e){if(!this.isNewClickValid(e.latlng))return;L.Editable.BaseEditor.prototype.onNewClickHandlerClicked.call(this,e);this.commitDrawing()}});L.Editable.PathEditor=L.Editable.BaseEditor.extend({CLOSED:false,MIN_VERTEX:2,enable:function(){if(this._enabled)return this;L.Editable.BaseEditor.prototype.enable.call(this);if(this.feature){this.initVertexMarkers()}return this},disable:function(){return L.Editable.BaseEditor.prototype.disable.call(this)},initVertexMarkers:function(){var latLngGroups=this.getLatLngsGroups();for(var i=0;i<latLngGroups.length;i++){this.addVertexMarkers(latLngGroups[i])}},getLatLngsGroups:function(){return[this.getLatLngs()]},getLatLngs:function(){return this.feature.getLatLngs()},reset:function(){this.editLayer.clearLayers();this.initVertexMarkers()},addVertexMarker:function(latlng,latlngs){return new this.tools.options.vertexMarkerClass(latlng,latlngs,this)},addVertexMarkers:function(latlngs){for(var i=0;i<latlngs.length;i++){this.addVertexMarker(latlngs[i],latlngs)}},addMiddleMarker:function(left,right,latlngs){return new this.tools.options.middleMarkerClass(left,right,latlngs,this)},onVertexMarkerClick:function(e){var index=e.vertex.getIndex();if(e.originalEvent.ctrlKey){this.onVertexMarkerCtrlClick(e)}else if(e.originalEvent.altKey){this.onVertexMarkerAltClick(e)}else if(e.originalEvent.shiftKey){this.onVertexMarkerShiftClick(e)}else if(index>=this.MIN_VERTEX-1&&index===e.vertex.getLastIndex()&&this.drawing===L.Editable.FORWARD){this.commitDrawing()}else if(index===0&&this.drawing===L.Editable.BACKWARD&&this._drawnLatLngs.length>=this.MIN_VERTEX){this.commitDrawing()}else if(index===0&&this.drawing===L.Editable.FORWARD&&this._drawnLatLngs.length>=this.MIN_VERTEX&&this.CLOSED){this.commitDrawing()}else{this.onVertexRawMarkerClick(e)}},onVertexRawMarkerClick:function(e){if(!this.vertexCanBeDeleted(e.vertex))return;e.vertex.delete();this.refresh()},vertexCanBeDeleted:function(vertex){return vertex.latlngs.length>this.MIN_VERTEX},onVertexDeleted:function(e){this.fireAndForward("editable:vertex:deleted",e)},onVertexMarkerCtrlClick:function(e){this.fireAndForward("editable:vertex:ctrlclick",e)},onVertexMarkerShiftClick:function(e){this.fireAndForward("editable:vertex:shiftclick",e)},onVertexMarkerAltClick:function(e){this.fireAndForward("editable:vertex:altclick",e)},onVertexMarkerContextMenu:function(e){this.fireAndForward("editable:vertex:contextmenu",e)},onVertexMarkerMouseDown:function(e){this.fireAndForward("editable:vertex:mousedown",e)},onMiddleMarkerMouseDown:function(e){this.fireAndForward("editable:middlemarker:mousedown",e)},onVertexMarkerDrag:function(e){this.fireAndForward("editable:vertex:drag",e)},onVertexMarkerDragStart:function(e){this.fireAndForward("editable:vertex:dragstart",e)},onVertexMarkerDragEnd:function(e){this.fireAndForward("editable:vertex:dragend",e)},startDrawing:function(){if(!this._drawnLatLngs)this._drawnLatLngs=this.getLatLngs();L.Editable.BaseEditor.prototype.startDrawing.call(this)},startDrawingForward:function(){this.startDrawing();this.tools.attachForwardLineGuide()},endDrawing:function(){L.Editable.BaseEditor.prototype.endDrawing.call(this);this.tools.detachForwardLineGuide();this.tools.detachBackwardLineGuide();delete this._drawnLatLngs},addLatLng:function(latlng){if(this.drawing===L.Editable.FORWARD)this._drawnLatLngs.push(latlng);else this._drawnLatLngs.unshift(latlng);this.refresh();this.addVertexMarker(latlng,this._drawnLatLngs)},newPointForward:function(latlng){this.addLatLng(latlng);this.tools.anchorForwardLineGuide(latlng);if(!this.tools.backwardLineGuide._latlngs[0]){this.tools.anchorBackwardLineGuide(latlng)}},newPointBackward:function(latlng){this.addLatLng(latlng);this.tools.anchorBackwardLineGuide(latlng)},onNewClickHandlerClicked:function(e){if(!this.isNewClickValid(e.latlng))return;if(this.drawing===L.Editable.FORWARD)this.newPointForward(e.latlng);else this.newPointBackward(e.latlng);L.Editable.BaseEditor.prototype.onNewClickHandlerClicked.call(this,e)},onMouseMove:function(e){if(this.drawing){L.Editable.BaseEditor.prototype.onMouseMove.call(this,e);this.tools.moveForwardLineGuide(e.latlng);this.tools.moveBackwardLineGuide(e.latlng)}},refresh:function(){this.feature.redraw();this.onEditing()}});L.Editable.PolylineEditor=L.Editable.PathEditor.extend({startDrawingBackward:function(){this.drawing=L.Editable.BACKWARD;this.startDrawing();this.tools.attachBackwardLineGuide()},continueBackward:function(){this.tools.anchorBackwardLineGuide(this.getFirstLatLng());this.startDrawingBackward()},continueForward:function(){this.tools.anchorForwardLineGuide(this.getLastLatLng());this.startDrawingForward()},getLastLatLng:function(){return this.getLatLngs()[this.getLatLngs().length-1]},getFirstLatLng:function(){return this.getLatLngs()[0]}});L.Editable.PolygonEditor=L.Editable.PathEditor.extend({CLOSED:true,MIN_VERTEX:3,getLatLngsGroups:function(){var groups=L.Editable.PathEditor.prototype.getLatLngsGroups.call(this);if(this.feature._holes){for(var i=0;i<this.feature._holes.length;i++){groups.push(this.feature._holes[i])}}return groups},startDrawingForward:function(){L.Editable.PathEditor.prototype.startDrawingForward.call(this);this.tools.attachBackwardLineGuide()},addNewEmptyHole:function(){var holes=Array();if(!this.feature._holes){this.feature._holes=[]}this.feature._holes.push(holes);return holes},newHole:function(latlng){this._drawnLatLngs=this.addNewEmptyHole();this.startDrawingForward();if(latlng)this.newPointForward(latlng)},checkContains:function(latlng){return this.feature._containsPoint(this.map.latLngToLayerPoint(latlng))},vertexCanBeDeleted:function(vertex){if(vertex.latlngs===this.getLatLngs())return L.Editable.PathEditor.prototype.vertexCanBeDeleted.call(this,vertex);else return true},isNewClickValid:function(latlng){if(this._drawnLatLngs!==this.getLatLngs())return this.checkContains(latlng);return true},onVertexDeleted:function(e){L.Editable.PathEditor.prototype.onVertexDeleted.call(this,e);if(!e.vertex.latlngs.length&&e.vertex.latlngs!==this.getLatLngs()){this.feature._holes.splice(this.feature._holes.indexOf(e.vertex.latlngs),1)}}});L.Map.mergeOptions({polylineEditorClass:L.Editable.PolylineEditor});L.Map.mergeOptions({polygonEditorClass:L.Editable.PolygonEditor});L.Map.mergeOptions({markerEditorClass:L.Editable.MarkerEditor});var EditableMixin={createEditor:function(map){map=map||this._map;var Klass=this.options.editorClass||this.getEditorClass(map);return new Klass(map,this,this.options.editOptions)},enableEdit:function(){if(!this.editor)this.createEditor();if(this.multi)this.multi.onEditEnabled();return this.editor.enable()},editEnabled:function(){return this.editor&&this.editor._enabled},disableEdit:function(){if(this.editor){if(this.multi)this.multi.onEditDisabled();this.editor.disable();delete this.editor}},toggleEdit:function(){if(this.editEnabled()){this.disableEdit()}else{this.enableEdit()}}};L.Polyline.include(EditableMixin);L.Polygon.include(EditableMixin);L.Marker.include(EditableMixin);L.Polyline.include({_containsPoint:function(p,closed){var i,j,k,len,len2,dist,part,w=this.options.weight/2;if(L.Browser.touch){w+=10}for(i=0,len=this._parts.length;i<len;i++){part=this._parts[i];for(j=0,len2=part.length,k=len2-1;j<len2;k=j++){if(!closed&&j===0){continue}dist=L.LineUtil.pointToSegmentDistance(p,part[k],part[j]);if(dist<=w){return true}}}return false},getEditorClass:function(map){return map.options.polylineEditorClass}});L.Polygon.include({_containsPoint:function(p){var inside=false,part,p1,p2,i,j,k,len,len2;if(L.Polyline.prototype._containsPoint.call(this,p,true)){return true}for(i=0,len=this._parts.length;i<len;i++){part=this._parts[i];for(j=0,len2=part.length,k=len2-1;j<len2;k=j++){p1=part[j];p2=part[k];if(p1.y>p.y!==p2.y>p.y&&p.x<(p2.x-p1.x)*(p.y-p1.y)/(p2.y-p1.y)+p1.x){inside=!inside}}}return inside},getEditorClass:function(map){return map.options.polygonEditorClass}});L.Marker.include({getEditorClass:function(map){return map.options.markerEditorClass}});var MultiEditableMixin={enableEdit:function(){this.eachLayer(function(layer){layer.multi=this;layer.enableEdit()},this)},disableEdit:function(){this.eachLayer(function(layer){layer.disableEdit()})},toggleEdit:function(e){if(!e.layer.editor){this.enableEdit(e)}else{this.disableEdit()}},onEditEnabled:function(){if(!this._editEnabled){this._editEnabled=true;this.fire("editable:multi:edit:enabled")}},onEditDisabled:function(){if(this._editEnabled){this._editEnabled=false;this.fire("editable:multi:edit:disabled")}},editEnabled:function(){return!!this._editEnabled}};L.MultiPolygon.include(MultiEditableMixin);L.MultiPolyline.include(MultiEditableMixin);L.Control.GraphicScale=L.Control.extend({options:{position:"bottomleft",updateWhenIdle:false,minUnitWidth:30,maxUnitsWidth:240,fill:false,showSubunits:false,doubleLine:false},onAdd:function(map){this._map=map;this._possibleUnitsNum=[3,5,2,4];this._possibleUnitsNumLen=this._possibleUnitsNum.length;this._possibleDivisions=[1,.5,.25,.2];this._possibleDivisionsLen=this._possibleDivisions.length;this._possibleDivisionsSub={1:{num:2,division:.5},.5:{num:5,division:.1},.25:{num:5,division:.05},.2:{num:2,division:.1}};this._scaleInner=this._buildScale();this._scale=this._addScale(this._scaleInner);this._setStyle(this.options);map.on(this.options.updateWhenIdle?"moveend":"move",this._update,this);map.whenReady(this._update,this);return this._scale},onRemove:function(map){map.off(this.options.updateWhenIdle?"moveend":"move",this._update,this)},_addScale:function(scaleInner){var scale=L.DomUtil.create("div");scale.className="leaflet-control-graphicscale";scale.appendChild(scaleInner);return scale},_setStyle:function(options){var classNames=["leaflet-control-graphicscale-inner"];if(options.fill&&options.fill!=="nofill"){classNames.push("filled");classNames.push("filled-"+options.fill)}if(options.showSubunits){classNames.push("showsubunits")}if(options.doubleLine){classNames.push("double")}this._scaleInner.className=classNames.join(" ")},_buildScale:function(){var root=document.createElement("div");root.className="leaflet-control-graphicscale-inner";var subunits=L.DomUtil.create("div","subunits",root);var units=L.DomUtil.create("div","units",root);this._units=[];this._unitsLbls=[];this._subunits=[];for(var i=0;i<5;i++){var unit=this._buildDivision(i%2===0);units.appendChild(unit);this._units.push(unit);var unitLbl=this._buildDivisionLbl();unit.appendChild(unitLbl);this._unitsLbls.push(unitLbl);var subunit=this._buildDivision(i%2===1);subunits.appendChild(subunit);this._subunits.unshift(subunit)}this._zeroLbl=L.DomUtil.create("div","label zeroLabel");this._zeroLbl.innerHTML="0";this._units[0].appendChild(this._zeroLbl);this._subunitsLbl=L.DomUtil.create("div","label subunitsLabel");this._subunitsLbl.innerHTML="?";this._subunits[4].appendChild(this._subunitsLbl);return root},_buildDivision:function(fill){var item=L.DomUtil.create("div","division");var l1=L.DomUtil.create("div","line");item.appendChild(l1);var l2=L.DomUtil.create("div","line2");item.appendChild(l2);if(fill)l1.appendChild(L.DomUtil.create("div","fill"));if(!fill)l2.appendChild(L.DomUtil.create("div","fill"));return item},_buildDivisionLbl:function(){var itemLbl=L.DomUtil.create("div","label divisionLabel");return itemLbl},_update:function(){var bounds=this._map.getBounds(),centerLat=bounds.getCenter().lat,halfWorldMeters=6378137*Math.PI*Math.cos(centerLat*Math.PI/180),dist=halfWorldMeters*(bounds.getNorthEast().lng-bounds.getSouthWest().lng)/180,size=this._map.getSize();if(size.x>0){this._updateScale(dist,this.options)}},_updateScale:function(maxMeters,options){var scale=this._getBestScale(maxMeters,options.minUnitWidth,options.maxUnitsWidth);this._render(scale)},_getBestScale:function(maxMeters,minUnitWidthPx,maxUnitsWidthPx){var possibleUnits=this._getPossibleUnits(maxMeters,minUnitWidthPx,this._map.getSize().x);var possibleScales=this._getPossibleScales(possibleUnits,maxUnitsWidthPx);possibleScales.sort(function(scaleA,scaleB){return scaleB.score-scaleA.score});var scale=possibleScales[0];scale.subunits=this._getSubunits(scale);return scale},_getSubunits:function(scale){var subdivision=this._possibleDivisionsSub[scale.unit.unitDivision];var subunit={};subunit.subunitDivision=subdivision.division;subunit.subunitMeters=subdivision.division*(scale.unit.unitMeters/scale.unit.unitDivision);subunit.subunitPx=subdivision.division*(scale.unit.unitPx/scale.unit.unitDivision);var subunits={subunit:subunit,numSubunits:subdivision.num,total:subdivision.num*subunit.subunitMeters};return subunits},_getPossibleScales:function(possibleUnits,maxUnitsWidthPx){var scales=[];var minTotalWidthPx=Number.POSITIVE_INFINITY;var fallbackScale;for(var i=0;i<this._possibleUnitsNumLen;i++){var numUnits=this._possibleUnitsNum[i];var numUnitsScore=(this._possibleUnitsNumLen-i)*.5;for(var j=0;j<possibleUnits.length;j++){var unit=possibleUnits[j];var totalWidthPx=unit.unitPx*numUnits;var scale={unit:unit,totalWidthPx:totalWidthPx,numUnits:numUnits,score:0};var totalWidthPxScore=1-(maxUnitsWidthPx-totalWidthPx)/maxUnitsWidthPx;totalWidthPxScore*=3;var score=unit.unitScore+numUnitsScore+totalWidthPxScore;if(unit.unitDivision===.25&&numUnits===3||unit.unitDivision===.5&&numUnits===3||unit.unitDivision===.25&&numUnits===5){score-=2}scale.score=score;if(totalWidthPx<maxUnitsWidthPx){scales.push(scale)}if(totalWidthPx<minTotalWidthPx){minTotalWidthPx=totalWidthPx;fallbackScale=scale}}}if(!scales.length)scales.push(fallbackScale);return scales},_getPossibleUnits:function(maxMeters,minUnitWidthPx,mapWidthPx){var exp=(Math.floor(maxMeters)+"").length;var unitMetersPow;var units=[];for(var i=exp;i>0;i--){unitMetersPow=Math.pow(10,i);for(var j=0;j<this._possibleDivisionsLen;j++){var unitMeters=unitMetersPow*this._possibleDivisions[j];var unitPx=mapWidthPx*(unitMeters/maxMeters);if(unitPx<minUnitWidthPx){return units}units.push({unitMeters:unitMeters,unitPx:unitPx,unitDivision:this._possibleDivisions[j],unitScore:this._possibleDivisionsLen-j})}}return units},_render:function(scale){this._renderPart(scale.unit.unitPx,scale.unit.unitMeters,scale.numUnits,this._units,this._unitsLbls);this._renderPart(scale.subunits.subunit.subunitPx,scale.subunits.subunit.subunitMeters,scale.subunits.numSubunits,this._subunits);var subunitsDisplayUnit=this._getDisplayUnit(scale.subunits.total);this._subunitsLbl.innerHTML=""+subunitsDisplayUnit.amount+subunitsDisplayUnit.unit},_renderPart:function(px,meters,num,divisions,divisionsLbls){var displayUnit=this._getDisplayUnit(meters);for(var i=0;i<this._units.length;i++){var division=divisions[i];if(i<num){division.style.width=px+"px";division.className="division"}else{division.style.width=0;division.className="division hidden"}if(!divisionsLbls)continue;var lbl=divisionsLbls[i];var lblClassNames=["label","divisionLabel"];if(i<num){var lblText=(i+1)*displayUnit.amount;if(i===num-1){lblText+=displayUnit.unit;lblClassNames.push("labelLast")}else{lblClassNames.push("labelSub")}lbl.innerHTML=lblText}lbl.className=lblClassNames.join(" ")}},_getDisplayUnit:function(meters){var displayUnit=meters<1e3?"m":"km";return{unit:displayUnit,amount:displayUnit==="km"?meters/1e3:meters}}});L.Map.mergeOptions({graphicScaleControl:false});L.Map.addInitHook(function(){if(this.options.graphicScaleControl){this.graphicScaleControl=new L.Control.GraphicScale;this.addControl(this.graphicScaleControl)}});L.control.graphicScale=function(options){return new L.Control.GraphicScale(options)};(function(factory,window){if(typeof define==="function"&&define.amd){define(["leaflet"],factory)}else if(typeof exports==="object"){if(typeof window!=="undefined"&&window.L){module.exports=factory(L)}else{module.exports=factory(require("leaflet"))}}if(typeof window!=="undefined"&&window.L){window.L.Control.Locate=factory(L)}})(function(L){var LocateControl=L.Control.extend({options:{position:"topleft",layer:undefined,setView:"untilPan",keepCurrentZoomLevel:false,clickBehavior:{inView:"stop",outOfView:"setView"},drawCircle:true,drawMarker:true,markerClass:L.CircleMarker,circleStyle:{color:"#136AEC",fillColor:"#136AEC",fillOpacity:.15,weight:2,opacity:.5},markerStyle:{color:"#136AEC",fillColor:"#2A93EE",fillOpacity:.7,weight:2,opacity:.9,radius:5},followCircleStyle:{},followMarkerStyle:{},icon:"fa fa-map-marker",iconLoading:"fa fa-spinner fa-spin",iconElementTag:"span",circlePadding:[0,0],metric:true,onLocationError:function(err,control){alert(err.message)},onLocationOutsideMapBounds:function(control){control.stop();alert(control.options.strings.outsideMapBoundsMsg)},showPopup:true,strings:{title:"Show me where I am",metersUnit:"meters",feetUnit:"feet",popup:"You are within {distance} {unit} from this point",outsideMapBoundsMsg:"You seem located outside the boundaries of the map"},locateOptions:{maxZoom:Infinity,watch:true,setView:false}},initialize:function(options){for(var i in options){if(typeof this.options[i]==="object"){L.extend(this.options[i],options[i])}else{this.options[i]=options[i]}}this.options.followMarkerStyle=L.extend({},this.options.markerStyle,this.options.followMarkerStyle);this.options.followCircleStyle=L.extend({},this.options.circleStyle,this.options.followCircleStyle)},onAdd:function(map){var container=L.DomUtil.create("div","leaflet-control-locate leaflet-bar leaflet-control");this._layer=this.options.layer||new L.LayerGroup;this._layer.addTo(map);this._event=undefined;this._link=L.DomUtil.create("a","leaflet-bar-part leaflet-bar-part-single",container);this._link.href="#";this._link.title=this.options.strings.title;this._icon=L.DomUtil.create(this.options.iconElementTag,this.options.icon,this._link);L.DomEvent.on(this._link,"click",L.DomEvent.stopPropagation).on(this._link,"click",L.DomEvent.preventDefault).on(this._link,"click",this._onClick,this).on(this._link,"dblclick",L.DomEvent.stopPropagation);this._resetVariables();this._map.on("unload",this._unload,this);return container},_onClick:function(){this._justClicked=true;this._userPanned=false;if(this._active&&!this._event){this.stop()}else if(this._active&&this._event!==undefined){var behavior=this._map.getBounds().contains(this._event.latlng)?this.options.clickBehavior.inView:this.options.clickBehavior.outOfView;switch(behavior){case"setView":this.setView();break;case"stop":this.stop();break}}else{this.start()}this._updateContainerStyle()},start:function(){this._activate();if(this._event){this._drawMarker(this._map);if(this.options.setView){this.setView()}}this._updateContainerStyle()},stop:function(){this._deactivate();this._cleanClasses();this._resetVariables();this._removeMarker()},_activate:function(){if(!this._active){this._map.locate(this.options.locateOptions);this._active=true;this._map.on("locationfound",this._onLocationFound,this);this._map.on("locationerror",this._onLocationError,this);this._map.on("dragstart",this._onDrag,this)}},_deactivate:function(){this._map.stopLocate();this._active=false;this._map.off("locationfound",this._onLocationFound,this);this._map.off("locationerror",this._onLocationError,this);this._map.off("dragstart",this._onDrag,this)},setView:function(){if(this._isOutsideMapBounds()){this.options.onLocationOutsideMapBounds(this)}else{if(this.options.keepCurrentZoomLevel){this._map.panTo([this._event.latitude,this._event.longitude])}else{this._map.fitBounds(this._event.bounds,{padding:this.options.circlePadding,maxZoom:this.options.locateOptions.maxZoom})}}this._drawMarker()},_drawMarker:function(){if(this._event.accuracy===undefined){this._event.accuracy=0}var radius=this._event.accuracy;var latlng=this._event.latlng;if(this.options.drawCircle){var style=this._isFollowing()?this.options.followCircleStyle:this.options.circleStyle;if(!this._circle){this._circle=L.circle(latlng,radius,style).addTo(this._layer)}else{this._circle.setLatLng(latlng).setRadius(radius).setStyle(style)}}var distance,unit;if(this.options.metric){distance=radius.toFixed(0);unit=this.options.strings.metersUnit}else{distance=(radius*3.2808399).toFixed(0);unit=this.options.strings.feetUnit}if(this.options.drawMarker){var mStyle=this._isFollowing()?this.options.followMarkerStyle:this.options.markerStyle;if(!this._marker){this._marker=new this.options.markerClass(latlng,mStyle).addTo(this._layer)}else{this._marker.setLatLng(latlng).setStyle(mStyle)}}var t=this.options.strings.popup;if(this.options.showPopup&&t&&this._marker){this._marker.bindPopup(L.Util.template(t,{distance:distance,unit:unit}))._popup.setLatLng(latlng)}},_removeMarker:function(){this._layer.clearLayers();this._marker=undefined;this._circle=undefined},_unload:function(){this.stop();this._map.off("unload",this._unload,this)},_onLocationError:function(err){if(err.code==3&&this.options.locateOptions.watch){return}this.stop();this.options.onLocationError(err,this)},_onLocationFound:function(e){if(this._event&&(this._event.latlng.lat===e.latlng.lat&&this._event.latlng.lng===e.latlng.lng&&this._event.accuracy===e.accuracy)){return}if(!this._active){return}this._event=e;this._drawMarker();this._updateContainerStyle();switch(this.options.setView){case"once":if(this._justClicked){this.setView()}break;case"untilPan":if(!this._userPanned){this.setView()}break;case"always":this.setView();break;case false:break}this._justClicked=false},
_onDrag:function(){if(this._event){this._userPanned=true;this._updateContainerStyle();this._drawMarker()}},_isFollowing:function(){if(!this._active){return false}if(this.options.setView==="always"){return true}else if(this.options.setView==="untilPan"){return!this._userPanned}},_isOutsideMapBounds:function(){if(this._event===undefined){return false}return this._map.options.maxBounds&&!this._map.options.maxBounds.contains(this._event.latlng)},_updateContainerStyle:function(){if(!this._container){return}if(this._active&&!this._event){this._setClasses("requesting")}else if(this._isFollowing()){this._setClasses("following")}else if(this._active){this._setClasses("active")}else{this._cleanClasses()}},_setClasses:function(state){if(state=="requesting"){L.DomUtil.removeClasses(this._container,"active following");L.DomUtil.addClasses(this._container,"requesting");L.DomUtil.removeClasses(this._icon,this.options.icon);L.DomUtil.addClasses(this._icon,this.options.iconLoading)}else if(state=="active"){L.DomUtil.removeClasses(this._container,"requesting following");L.DomUtil.addClasses(this._container,"active");L.DomUtil.removeClasses(this._icon,this.options.iconLoading);L.DomUtil.addClasses(this._icon,this.options.icon)}else if(state=="following"){L.DomUtil.removeClasses(this._container,"requesting");L.DomUtil.addClasses(this._container,"active following");L.DomUtil.removeClasses(this._icon,this.options.iconLoading);L.DomUtil.addClasses(this._icon,this.options.icon)}},_cleanClasses:function(){L.DomUtil.removeClass(this._container,"requesting");L.DomUtil.removeClass(this._container,"active");L.DomUtil.removeClass(this._container,"following");L.DomUtil.removeClasses(this._icon,this.options.iconLoading);L.DomUtil.addClasses(this._icon,this.options.icon)},_resetVariables:function(){this._active=false;this._justClicked=false;this._userPanned=false}});L.control.locate=function(options){return new L.Control.Locate(options)};(function(){var LDomUtilApplyClassesMethod=function(method,element,classNames){classNames=classNames.split(" ");classNames.forEach(function(className){L.DomUtil[method].call(this,element,className)})};L.DomUtil.addClasses=function(el,names){LDomUtilApplyClassesMethod("addClass",el,names)};L.DomUtil.removeClasses=function(el,names){LDomUtilApplyClassesMethod("removeClass",el,names)}})();return LocateControl},window);(function(window,document,undefined){"use strict";L._Toolbar=(L.Layer||L.Class).extend({statics:{baseClass:"leaflet-toolbar"},includes:L.Mixin.Events,options:{className:"",filter:function(){return true},actions:[]},initialize:function(options){L.setOptions(this,options);this._toolbar_type=this.constructor._toolbar_class_id},addTo:function(map){this._arguments=[].slice.call(arguments);map.addLayer(this);return this},onAdd:function(map){var currentToolbar=map._toolbars[this._toolbar_type];if(this._calculateDepth()===0){if(currentToolbar){map.removeLayer(currentToolbar)}map._toolbars[this._toolbar_type]=this}},onRemove:function(map){if(this._calculateDepth()===0){delete map._toolbars[this._toolbar_type]}},appendToContainer:function(container){var baseClass=this.constructor.baseClass+"-"+this._calculateDepth(),className=baseClass+" "+this.options.className,Action,action,i,j,l,m;this._container=container;this._ul=L.DomUtil.create("ul",className,container);this._disabledEvents=["click","mousemove","dblclick"];for(j=0,m=this._disabledEvents.length;j<m;j++){L.DomEvent.on(this._ul,this._disabledEvents[j],L.DomEvent.stopPropagation)}for(i=0,l=this.options.actions.length;i<l;i++){Action=this._getActionConstructor(this.options.actions[i]);action=new Action;action._createIcon(this,this._ul,this._arguments)}},_getActionConstructor:function(Action){var args=this._arguments,toolbar=this;return Action.extend({initialize:function(){Action.prototype.initialize.apply(this,args)},enable:function(e){if(toolbar._active){toolbar._active.disable()}toolbar._active=this;Action.prototype.enable.call(this,e)}})},_hide:function(){this._ul.style.display="none"},_show:function(){this._ul.style.display="block"},_calculateDepth:function(){var depth=0,toolbar=this.parentToolbar;while(toolbar){depth+=1;toolbar=toolbar.parentToolbar}return depth}});L._toolbar={};var toolbar_class_id=0;L._Toolbar.extend=function extend(props){var statics=L.extend({},props.statics,{_toolbar_class_id:toolbar_class_id});toolbar_class_id+=1;L.extend(props,{statics:statics});return L.Class.extend.call(this,props)};L.Map.addInitHook(function(){this._toolbars={}});L._ToolbarAction=L.Handler.extend({statics:{baseClass:"leaflet-toolbar-icon"},options:{toolbarIcon:{html:"",className:"",tooltip:""},subToolbar:new L._Toolbar},initialize:function(options){var defaultIconOptions=L._ToolbarAction.prototype.options.toolbarIcon;L.setOptions(this,options);this.options.toolbarIcon=L.extend({},defaultIconOptions,this.options.toolbarIcon)},enable:function(e){if(e){L.DomEvent.preventDefault(e)}if(this._enabled){return}this._enabled=true;if(this.addHooks){this.addHooks()}},disable:function(){if(!this._enabled){return}this._enabled=false;if(this.removeHooks){this.removeHooks()}},_createIcon:function(toolbar,container,args){var iconOptions=this.options.toolbarIcon;this.toolbar=toolbar;this._icon=L.DomUtil.create("li","",container);this._link=L.DomUtil.create("a","",this._icon);this._link.innerHTML=iconOptions.html;this._link.setAttribute("href","#");this._link.setAttribute("title",iconOptions.tooltip);L.DomUtil.addClass(this._link,this.constructor.baseClass);if(iconOptions.className){L.DomUtil.addClass(this._link,iconOptions.className)}L.DomEvent.on(this._link,"click",this.enable,this);this._addSubToolbar(toolbar,this._icon,args)},_addSubToolbar:function(toolbar,container,args){var subToolbar=this.options.subToolbar,addHooks=this.addHooks,removeHooks=this.removeHooks;subToolbar.parentToolbar=toolbar;if(subToolbar.options.actions.length>0){args=[].slice.call(args);args.push(this);subToolbar.addTo.apply(subToolbar,args);subToolbar.appendToContainer(container);this.addHooks=function(map){if(typeof addHooks==="function"){addHooks.call(this,map)}subToolbar._show()};this.removeHooks=function(map){if(typeof removeHooks==="function"){removeHooks.call(this,map)}subToolbar._hide()}}}});L._toolbarAction=function toolbarAction(options){return new L._ToolbarAction(options)};L._ToolbarAction.extendOptions=function(options){return this.extend({options:options})};L._Toolbar.Control=L._Toolbar.extend({statics:{baseClass:"leaflet-control-toolbar "+L._Toolbar.baseClass},initialize:function(options){L._Toolbar.prototype.initialize.call(this,options);this._control=new L.Control._Toolbar(this.options)},onAdd:function(map){this._control.addTo(map);L._Toolbar.prototype.onAdd.call(this,map);this.appendToContainer(this._control.getContainer())},onRemove:function(map){L._Toolbar.prototype.onRemove.call(this,map);if(this._control.remove){this._control.remove()}else{this._control.removeFrom(map)}}});L.Control._Toolbar=L.Control.extend({onAdd:function(){return L.DomUtil.create("div","")}});L._toolbar.control=function(options){return new L._Toolbar.Control(options)};L._Toolbar.Popup=L._Toolbar.extend({statics:{baseClass:"leaflet-popup-toolbar "+L._Toolbar.baseClass},options:{anchor:[0,0]},initialize:function(latlng,options){L._Toolbar.prototype.initialize.call(this,options);this._marker=new L.Marker(latlng,{icon:new L.DivIcon({className:this.options.className,iconAnchor:[0,0]})})},onAdd:function(map){this._map=map;this._marker.addTo(map);L._Toolbar.prototype.onAdd.call(this,map);this.appendToContainer(this._marker._icon);this._setStyles()},onRemove:function(map){map.removeLayer(this._marker);L._Toolbar.prototype.onRemove.call(this,map);delete this._map},setLatLng:function(latlng){this._marker.setLatLng(latlng);return this},_setStyles:function(){var container=this._container,toolbar=this._ul,anchor=L.point(this.options.anchor),icons=toolbar.querySelectorAll(".leaflet-toolbar-icon"),buttonHeights=[],toolbarWidth=0,toolbarHeight,tipSize,tipAnchor;for(var i=0,l=icons.length;i<l;i++){if(icons[i].parentNode.parentNode===toolbar){buttonHeights.push(parseInt(L.DomUtil.getStyle(icons[i],"height"),10));toolbarWidth+=Math.ceil(parseFloat(L.DomUtil.getStyle(icons[i],"width")))}}toolbar.style.width=toolbarWidth+"px";this._tipContainer=L.DomUtil.create("div","leaflet-toolbar-tip-container",container);this._tipContainer.style.width=toolbarWidth+"px";this._tip=L.DomUtil.create("div","leaflet-toolbar-tip",this._tipContainer);toolbarHeight=Math.max.apply(undefined,buttonHeights);tipSize=parseInt(L.DomUtil.getStyle(this._tip,"width"),10);tipAnchor=new L.Point(toolbarWidth/2,toolbarHeight+.7071*tipSize);container.style.marginLeft=anchor.x-tipAnchor.x+"px";container.style.marginTop=anchor.y-tipAnchor.y+"px"}});L._toolbar.popup=function(options){return new L._Toolbar.Popup(options)}})(window,document);